<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Data Extractor - AI Powered</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- jsPDF Core Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- jsPDF AutoTable plugin for creating tables in PDFs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .loader {
            border: 2px solid #e5e7eb;
            border-top: 2px solid #4f46e5;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #camera-modal {
            background-color: rgba(0,0,0,0.6);
        }
        #camera-video {
            transform: scaleX(-1);
        }
        #flash-overlay.flash {
            animation: flash-animation 0.3s ease-out;
        }
        @keyframes flash-animation {
            from { opacity: 0.7; }
            to { opacity: 0; }
        }
        .editable-input {
            width: 100%;
            border: 1px solid transparent;
            padding: 6px 8px;
            border-radius: 6px;
            background-color: transparent;
            transition: all 0.2s ease-in-out;
        }
        .editable-input:hover {
            background-color: #f9fafb;
            border-color: #d1d5db;
        }
        .editable-input:focus {
            outline: 2px solid transparent;
            outline-offset: 2px;
            border-color: #4f46e5;
            background-color: #ffffff;
            box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.5);
        }
        .status-icon {
            width: 20px;
            height: 20px;
            margin-right: 8px;
        }
        .retry-btn {
            background-color: #4f46e5;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 4px 10px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .retry-btn:hover {
            background-color: #4338ca;
        }
        .retry-btn:disabled {
            background-color: #a5b4fc;
            cursor: not-allowed;
        }
    </style>
</head>
<body class="antialiased text-gray-800">

    <div class="container mx-auto max-w-6xl p-4 md:p-8">
        <div class="bg-white rounded-2xl shadow-xl p-6 md:p-8">
            <div class="text-center mb-8">
                <h1 class="text-3xl md:text-4xl font-bold text-gray-900">Smart Product Data Extractor</h1>
                <p class="text-gray-500 mt-2">Powered by AI for accurate data extraction.</p>
            </div>
            
            <div id="notification-area" class="text-center text-red-600 mb-6 min-h-[1.25rem] font-semibold flex items-center justify-center gap-2"></div>

            <div class="flex flex-col sm:flex-row justify-center items-center gap-4 mb-8">
                <label for="image-upload-input" class="w-full sm:w-auto cursor-pointer inline-flex justify-center items-center py-3 px-6 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg>
                    Upload Images
                </label>
                <input id="image-upload-input" type="file" class="hidden" accept="image/*" multiple>
                
                <button id="camera-btn" class="w-full sm:w-auto inline-flex justify-center items-center py-3 px-6 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                    Use Camera
                </button>
            </div>

            <div class="overflow-x-auto bg-gray-50 rounded-lg">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-100">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Preview</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Product Name</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Prod. Date</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Expiry Date</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Batch No.</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                        </tr>
                    </thead>
                    <tbody id="results-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                </table>
                 <div id="no-data-msg" class="text-center text-gray-500 py-16">
                    <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                    <h3 class="mt-2 text-sm font-medium text-gray-900">No images added</h3>
                    <p class="mt-1 text-sm text-gray-500">Get started by uploading an image or using the camera.</p>
                 </div>
            </div>
            
            <div class="mt-8 flex flex-col sm:flex-row justify-end gap-4">
                 <button id="csv-btn" class="w-full sm:w-auto inline-flex justify-center py-3 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-emerald-600 hover:bg-emerald-700 disabled:bg-emerald-300" disabled>Export to CSV</button>
                 <button id="pdf-btn" class="w-full sm:w-auto inline-flex justify-center py-3 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-red-600 hover:bg-red-700 disabled:bg-red-300" disabled>Generate PDF</button>
                 <button id="clear-btn" class="w-full sm:w-auto inline-flex justify-center py-3 px-4 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">Clear All</button>
            </div>
        </div>
    </div>

    <div id="camera-modal" class="fixed inset-0 z-50 items-center justify-center hidden">
        <div class="bg-white rounded-lg shadow-xl p-4 max-w-lg w-full relative">
            <video id="camera-video" class="w-full rounded-md" autoplay playsinline></video>
            <div id="flash-overlay" class="absolute inset-0 bg-white opacity-0 pointer-events-none rounded-md"></div>
            <div class="flex justify-center gap-4 mt-4">
                <button id="capture-btn" class="py-2 px-4 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">Capture</button>
                <button id="close-camera-btn" class="py-2 px-4 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Close</button>
            </div>
        </div>
    </div>
    <canvas id="camera-canvas" class="hidden"></canvas>

    <script>
        const { jsPDF } = window.jspdf;
        const dom = {
            imageUploadInput: document.getElementById('image-upload-input'),
            cameraBtn: document.getElementById('camera-btn'),
            resultsTableBody: document.getElementById('results-table-body'),
            noDataMsg: document.getElementById('no-data-msg'),
            pdfBtn: document.getElementById('pdf-btn'),
            csvBtn: document.getElementById('csv-btn'),
            clearBtn: document.getElementById('clear-btn'),
            notificationArea: document.getElementById('notification-area'),
            cameraModal: document.getElementById('camera-modal'),
            cameraVideo: document.getElementById('camera-video'),
            captureBtn: document.getElementById('capture-btn'),
            closeCameraBtn: document.getElementById('close-camera-btn'),
            cameraCanvas: document.getElementById('camera-canvas'),
            flashOverlay: document.getElementById('flash-overlay')
        };

        let mediaStream = null;
        const imageQueue = [];
        let activeProcessingCount = 0;
        const MAX_CONCURRENT_REQUESTS = 3;

        // --- Core Logic ---
        async function handleImageCapture(base64Data, dataUrl) {
            const id = `img-${Date.now()}-${Math.random()}`;
            dom.noDataMsg.style.display = 'none';
            addTableRow(id, dataUrl, base64Data);
            imageQueue.push({ id, base64Data });
            processQueue();
        }

        function processQueue() {
            while (activeProcessingCount < MAX_CONCURRENT_REQUESTS && imageQueue.length > 0) {
                activeProcessingCount++;
                const { id, base64Data } = imageQueue.shift();
                
                updateTableRowStatus(id, 'processing');

                callGeminiAPI(base64Data)
                    .then(result => {
                        updateTableRowData(id, result || {}, result ? 'success' : 'failed');
                        if (result) {
                            dom.pdfBtn.disabled = false;
                            dom.csvBtn.disabled = false;
                        }
                    })
                    .catch(error => {
                        console.error('Error processing image:', error);
                        updateTableRowData(id, {}, 'failed');
                    })
                    .finally(() => {
                        activeProcessingCount--;
                        processQueue(); // Check if more images can be processed
                    });
            }
        }

        async function retryImageProcessing(id) {
            const row = document.getElementById(id);
            if (!row || !row.dataset.base64) return;

            const base64Data = row.dataset.base64;
            updateTableRowStatus(id, 'processing');

            try {
                const result = await callGeminiAPI(base64Data);
                updateTableRowData(id, result || {}, result ? 'success' : 'failed');
                 if (result) {
                    dom.pdfBtn.disabled = false;
                    dom.csvBtn.disabled = false;
                }
            } catch (error) {
                console.error('Error retrying image:', error);
                updateTableRowData(id, {}, 'failed');
            }
        }

        async function callGeminiAPI(imageData) {
             const apiKey = "";
             const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
             const detailedPrompt = `Analyze the product image. Extract the product name, production date, expiry date, and batch number. Return a JSON object with keys: 'productName', 'productionDate', 'expiryDate', 'batchNumber'. EXAMPLE: For a label with "Production Date : 19/06/2025", "Expiry Date : 16/03/2026", "Batch Code : 0000561227-2131", you must return {"productName": "ALBAIK SHRIMPS VALUE NORMAL", "productionDate": "19/06/2025", "expiryDate": "16/03/2026", "batchNumber": "0000561227-2131"}. IMPORTANT: Only extract data clearly labeled with keywords. If a value is not found, return an empty string.`;

             const payload = {
                 contents: [{ parts: [{ text: detailedPrompt }, { inlineData: { mimeType: "image/jpeg", data: imageData } }] }],
                 generationConfig: {
                     responseMimeType: "application/json",
                     responseSchema: {
                         type: "OBJECT",
                         properties: {
                             productName: { type: "STRING" },
                             productionDate: { type: "STRING" },
                             expiryDate: { type: "STRING" },
                             batchNumber: { type: "STRING" }
                         }
                     }
                 }
             };

             for (let i = 0; i < 3; i++) {
                 try {
                     const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                     if (response.ok) {
                         const result = await response.json();
                         const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                         if (jsonText) return JSON.parse(jsonText);
                     }
                 } catch (error) {
                     console.error(`API call attempt ${i + 1} failed:`, error);
                     if (i < 2) await new Promise(res => setTimeout(res, 1000 * (i + 1)));
                     else throw error;
                 }
             }
             return null;
        }

        // --- UI Functions ---
        function addTableRow(id, thumbnailUrl, base64Data) {
            const row = dom.resultsTableBody.insertRow();
            row.id = id;
            row.dataset.base64 = base64Data;
            row.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap"><img src="${thumbnailUrl}" class="h-12 w-12 object-cover rounded-lg shadow-md"></td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 data-cell" colspan="4">Queued...</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 status-cell"></td>
            `;
            updateTableRowStatus(id, 'queued');
        }
        
        function updateTableRowStatus(id, status) {
            const row = document.getElementById(id);
            if (!row) return;
            
            const statusCell = row.querySelector('.status-cell');
            row.dataset.status = status;
            
            let statusHtml = '';
            switch(status) {
                case 'queued':
                    statusHtml = `<div class="flex items-center text-gray-500"><svg class="status-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>Queued</div>`;
                    break;
                case 'processing':
                    statusHtml = `<div class="flex items-center text-indigo-600"><div class="loader status-icon"></div>Processing</div>`;
                    break;
            }
            if (statusCell) statusCell.innerHTML = statusHtml;
        }

        function updateTableRowData(id, data, status) {
            const row = document.getElementById(id);
            if (!row) return;

            row.dataset.status = status;
            const statusCell = row.querySelector('.status-cell');
            const dataCell = row.querySelector('.data-cell');
            
            if (dataCell) dataCell.remove();

            let statusHtml;
            if (status === 'success') {
                statusHtml = `<div class="flex items-center text-green-600 font-medium"><svg class="status-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>Success</div>`;
            } else {
                statusHtml = `<div class="flex items-center text-red-600 font-medium"><svg class="status-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>Failed <button class="retry-btn ml-2">Retry</button></div>`;
            }

            const dataHtml = `
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900"><input type="text" class="editable-input" value="${data.productName || ''}"></td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"><input type="text" class="editable-input" value="${data.productionDate || ''}"></td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"><input type="text" class="editable-input" value="${data.expiryDate || ''}"></td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"><input type="text" class="editable-input" value="${data.batchNumber || ''}"></td>
            `;
            
            const existingDataCells = row.querySelectorAll('td:not(:first-child):not(.status-cell)');
            existingDataCells.forEach(cell => cell.remove());

            row.insertAdjacentHTML('beforeend', dataHtml);
            statusCell.innerHTML = statusHtml;
        }
        
        function generatePdf() {
            const doc = new jsPDF();
            const tableData = [];
            const headers = [['Product Name', 'Production Date', 'Expiry Date', 'Batch No.']];
            dom.resultsTableBody.querySelectorAll('tr').forEach(row => {
                if (row.dataset.status === 'success') {
                    const inputs = row.querySelectorAll('.editable-input');
                    tableData.push([inputs[0].value, inputs[1].value, inputs[2].value, inputs[3].value]);
                }
            });
            if (tableData.length === 0) {
                alert("No successfully processed data to generate a PDF.");
                return;
            }
            doc.autoTable({ head: headers, body: tableData, startY: 20 });
            doc.save('product-data-report.pdf');
        }

        function generateCSV() {
            let csvContent = "data:text/csv;charset=utf-8,";
            const headers = ['Product Name', 'Production Date', 'Expiry Date', 'Batch No.'];
            csvContent += headers.join(",") + "\r\n";

            let rowsFound = 0;
            dom.resultsTableBody.querySelectorAll('tr').forEach(row => {
                if (row.dataset.status === 'success') {
                    rowsFound++;
                    const inputs = row.querySelectorAll('.editable-input');
                    const rowData = [
                        `"${inputs[0].value}"`, 
                        inputs[1].value,
                        inputs[2].value,
                        inputs[3].value
                    ];
                    csvContent += rowData.join(",") + "\r\n";
                }
            });

            if (rowsFound === 0) {
                alert("No successfully processed data to export.");
                return;
            }
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "product-data-report.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function closeCamera() {
            if (mediaStream) mediaStream.getTracks().forEach(track => track.stop());
            dom.cameraModal.style.display = 'none';
        }

        // --- Event Listeners Setup ---
        window.addEventListener('load', () => {
            dom.notificationArea.textContent = 'Ready';
        });
        
        dom.clearBtn.addEventListener('click', () => {
             imageQueue.length = 0;
             dom.resultsTableBody.innerHTML = '';
             dom.noDataMsg.style.display = 'block';
             dom.pdfBtn.disabled = true;
             dom.csvBtn.disabled = true;
        });

        dom.imageUploadInput.addEventListener('change', (event) => {
            Array.from(event.target.files).forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => handleImageCapture(e.target.result.split(',')[1], e.target.result);
                reader.readAsDataURL(file);
            });
            event.target.value = null;
        });

        dom.cameraBtn.addEventListener('click', async () => {
            try {
                mediaStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                dom.cameraVideo.srcObject = mediaStream;
                dom.cameraModal.style.display = 'flex';
            } catch (err) { console.error("Error accessing camera: ", err); }
        });

        dom.captureBtn.addEventListener('click', () => {
             const context = dom.cameraCanvas.getContext('2d');
             dom.cameraCanvas.width = dom.cameraVideo.videoWidth;
             dom.cameraCanvas.height = dom.cameraVideo.videoHeight;
             context.translate(dom.cameraCanvas.width, 0);
             context.scale(-1, 1);
             context.drawImage(dom.cameraVideo, 0, 0, dom.cameraCanvas.width, dom.cameraCanvas.height);
             dom.flashOverlay.classList.add('flash');
             setTimeout(() => dom.flashOverlay.classList.remove('flash'), 300);
             const dataUrl = dom.cameraCanvas.toDataURL('image/jpeg');
             handleImageCapture(dataUrl.split(',')[1], dataUrl);
        });
        
        dom.closeCameraBtn.addEventListener('click', closeCamera);
        dom.pdfBtn.addEventListener('click', generatePdf);
        dom.csvBtn.addEventListener('click', generateCSV);
        
        dom.resultsTableBody.addEventListener('click', (event) => {
            if (event.target.classList.contains('retry-btn')) {
                const button = event.target;
                const row = button.closest('tr');
                if (row) {
                    button.disabled = true;
                    button.textContent = 'Retrying...';
                    retryImageProcessing(row.id);
                }
            }
        });
    </script>
</body>
</html>
