<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Smart Product Data Extractor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Libraries loaded with defer to prevent blocking -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js" defer></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            -webkit-tap-highlight-color: transparent;
        }
        button, label { touch-action: manipulation; }
        
        .loader {
            border: 2px solid #e5e7eb;
            border-top: 2px solid #4f46e5;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        #camera-modal, #json-modal {
            background-color: rgba(0,0,0,0.95);
            backdrop-filter: blur(4px);
        }
        #camera-video { object-fit: cover; }
        
        .editable-input {
            width: 100%;
            min-width: 90px;
            border: 1px solid transparent;
            padding: 8px;
            border-radius: 6px;
            background-color: transparent;
            font-size: 13px;
        }
        .editable-input:focus {
            outline: none;
            border-color: #4f46e5;
            background-color: #fff;
            box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.2);
        }
        
        .table-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            background: white;
            border-radius: 0.75rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            min-height: 200px;
        }
        
        #toast-container {
            position: fixed;
            bottom: 20px; left: 20px; right: 20px;
            z-index: 9999;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }
        .toast {
            pointer-events: auto;
            background: white;
            padding: 12px 24px;
            border-radius: 8px;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
            border-left: 4px solid #4f46e5;
            animation: slideUp 0.3s ease-out;
        }
        .toast.error { border-left-color: #ef4444; }
        .toast.success { border-left-color: #10b981; }
        @keyframes slideUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    </style>
</head>
<body class="antialiased text-gray-800">

    <div class="container mx-auto max-w-6xl p-4">
        <div class="bg-white rounded-2xl shadow-xl p-4 md:p-8 border border-gray-100 relative">
            <button id="settings-btn" class="absolute top-4 right-4 text-gray-400 hover:text-indigo-600 p-2 z-10" title="Settings">
                <i class="fas fa-cog text-xl"></i>
            </button>

            <div class="text-center mb-6">
                <h1 class="text-2xl md:text-3xl font-bold text-gray-900 tracking-tight flex justify-center items-center gap-2">
                    Smart Product Extractor
                    <span id="demo-indicator" class="text-xs bg-yellow-100 text-yellow-800 px-2 py-0.5 rounded-full border border-yellow-200 hidden">Demo Mode</span>
                </h1>
                <p class="text-gray-500 mt-2 text-sm">Automated Data Entry System</p>
            </div>
            
            <div class="flex flex-col sm:flex-row justify-center items-center gap-3 mb-6">
                <label class="w-full sm:w-auto cursor-pointer flex justify-center items-center py-3 px-6 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 active:scale-95 transition-all select-none">
                    <i class="fas fa-upload mr-2"></i> Upload Image
                    <input id="image-upload-input" type="file" class="hidden" accept="image/*" multiple>
                </label>
                <button id="camera-btn" class="w-full sm:w-auto flex justify-center items-center py-3 px-6 border border-gray-300 rounded-lg hover:bg-gray-50 active:scale-95 transition-all select-none">
                    <i class="fas fa-camera mr-2"></i> Camera
                </button>
            </div>

            <div class="table-container border border-gray-200 mb-6">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Img</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Code</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Name</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Barcode</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Prod</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Exp</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Batch</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Status</th>
                        </tr>
                    </thead>
                    <tbody id="results-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                </table>
                <div id="no-data-msg" class="text-center text-gray-500 py-12">
                    <i class="far fa-images text-4xl mb-2 text-gray-300"></i>
                    <p class="text-sm">Ready for extraction</p>
                </div>
            </div>
            
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 pt-4 border-t border-gray-100">
                 <button id="json-btn" class="flex justify-center items-center py-3 px-4 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed text-sm font-medium" disabled>
                     <i class="fas fa-code mr-2"></i> JSON
                 </button>
                 <button id="csv-btn" class="flex justify-center items-center py-3 px-4 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 disabled:opacity-50 disabled:cursor-not-allowed text-sm font-medium" disabled>
                     <i class="fas fa-file-csv mr-2"></i> CSV
                 </button>
                 <button id="pdf-btn" class="flex justify-center items-center py-3 px-4 bg-red-600 text-white rounded-lg hover:bg-red-700 disabled:opacity-50 disabled:cursor-not-allowed text-sm font-medium" disabled>
                     <i class="fas fa-file-pdf mr-2"></i> PDF
                 </button>
                 <button id="clear-btn" class="flex justify-center items-center py-3 px-4 border border-gray-300 rounded-lg hover:bg-gray-50 text-sm font-medium">
                     Clear
                 </button>
            </div>
        </div>
    </div>

    <!-- Camera UI -->
    <div id="camera-modal" class="fixed inset-0 z-50 hidden flex-col">
        <div class="flex-1 relative bg-black">
            <video id="camera-video" class="w-full h-full" autoplay playsinline></video>
            <div class="absolute bottom-8 left-0 right-0 flex justify-center gap-8 items-center pb-safe">
                <button id="close-camera-btn" class="p-4 text-white hover:text-gray-300"><i class="fas fa-times text-2xl"></i></button>
                <button id="capture-btn" class="h-16 w-16 bg-white rounded-full border-4 border-gray-300 active:scale-95 transition-transform"></button>
                <div class="w-10"></div>
            </div>
        </div>
    </div>
    
    <!-- JSON Settings -->
    <div id="json-modal" class="fixed inset-0 z-50 items-center justify-center hidden p-4 flex">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6 max-h-[90vh] overflow-y-auto">
            <h3 class="text-xl font-bold text-gray-900 mb-5">Automation Settings</h3>
            
            <div class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Start Row Index</label>
                    <input type="number" id="json-start-index" value="11" min="1" class="w-full border-gray-300 bg-gray-50 rounded-lg shadow-sm border p-2.5 focus:ring-indigo-500 focus:border-indigo-500 outline-none">
                    <p class="text-xs text-gray-500 mt-1">IDs will start counting from this number (e.g., r11).</p>
                </div>

                <div class="bg-blue-50 p-4 rounded-xl border border-blue-100">
                    <h4 class="text-sm font-bold text-blue-800 mb-3 uppercase flex items-center">
                        <i class="fas fa-snowflake mr-2"></i> Frozen Config
                    </h4>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs font-semibold text-gray-600 mb-1">Prod. Min (°C)</label>
                            <input type="number" id="json-temp-min" value="-20.8" step="0.1" class="w-full border-gray-300 bg-white rounded-lg p-2 text-sm outline-none">
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-gray-600 mb-1">Prod. Max (°C)</label>
                            <input type="number" id="json-temp-max" value="-18.0" step="0.1" class="w-full border-gray-300 bg-white rounded-lg p-2 text-sm outline-none">
                        </div>
                    </div>
                </div>

                <div class="bg-gray-50 p-4 rounded-xl border border-gray-200 text-sm text-gray-600">
                    <p class="mb-2 font-semibold">Sequence & Automation Logic:</p>
                    <ul class="list-disc pl-4 space-y-1 text-xs">
                        <li><strong>Order:</strong> Frozen first, then Chilled.</li>
                        <li><strong>Batch Filling:</strong> <br>1. Prompt Time -> Fill All Times.<br>2. Prompt Truck Temp -> Fill All Truck Temps.<br>3. Fill All Product Temps.<br>4. Fill Rest of Details.</li>
                    </ul>
                </div>
            </div>

            <div class="mt-8 flex justify-end gap-3">
                <button id="close-json-btn" class="px-5 py-3 bg-gray-100 text-gray-700 font-medium rounded-lg hover:bg-gray-200">Cancel</button>
                <button id="download-json-final-btn" class="px-5 py-3 bg-indigo-600 text-white font-medium rounded-lg hover:bg-indigo-700 shadow-lg flex items-center">
                    <i class="fas fa-download mr-2"></i> Download
                </button>
            </div>
        </div>
    </div>

    <!-- Hidden Helpers -->
    <canvas id="process-canvas" class="hidden"></canvas>
    <div id="toast-container"></div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- 1. Global State ---
        const imageDataStore = new Map();
        let mediaStream = null;
        let activeProcessingCount = 0;
        const MAX_CONCURRENT_REQUESTS = 2; // Conservative for mobile

        // --- 2. Data Definitions (Strictly from Excel) ---
        const CHILLED_CODES = [
            "1006000037", "1006000038", "1006000039", "1006000040", "1006000041", "1006000042",
            "1006000043", "1006000044", "1006000045", "1006000046", "1006000048",
            "1006000049", "1006000050", "1006000051", "1006000052", "1006000053",
            "1006000054", "1006000055", "1006000056", "1006000215", "1006000216", 
            "911120", "911121", "911122", "911123", "911124", "911130", "911131",
            "911132", "911133", "911134", "910005", "910006", "910007", "910008",
            "910009", "910120", "910121", "910122", "910123", "912479", "910004",
            "930100", "930200", "941110", "913000", "913100"
        ];

        const DROPDOWN_CATALOG = {
            "1006000020": { name: "ALBAIK CHICKEN FILLET NUGGETS", barcode: "6287031260065" },
            "1006000021": { name: "ALBAIK CHICKEN FILLET NUGGETS SPICY", barcode: "6287031260066" },
            "1006000022": { name: "ALBAIK CHICKEN FILLET SUPER", barcode: "6287031250077" },
            "1006000023": { name: "ALBAIK CHICKEN FILLET SUPER SPICY", barcode: "6287031250084" },
            "1006000024": { name: "ALBAIK CHICKEN FINGER", barcode: "6287031250091" },
            "1006000026": { name: "ALBAIK CHICKEN FILLET BURGER", barcode: "6287031250107" },
            "1006000027": { name: "ALBAIK CHICKEN FILLET BURGER SPICY", barcode: "6287031250114" },
            "1006000028": { name: "ALBAIK CHICKEN FILLET SUPER XT", barcode: "6287031250121" },
            "1006000029": { name: "ALBAIK CHICKEN FILLET SUPER SPICY XT", barcode: "6287031250138" },
            "1006000030": { name: "ALBAIK FISH FILLET NUGGETS", barcode: "6287031250145" },
            "1006000031": { name: "ALBAIK FISH FILLET SUPER", barcode: "6287031250152" },
            "1006000032": { name: "ALBAIK FISH FILLET NUGGETS SPICY", barcode: "6287031250268" },
            "1006000033": { name: "ALBAIK FISH FILLET SUPER SPICY", barcode: "6287031250275" },
            "1006000034": { name: "ALBAIK SHRIMPS JUMBO", barcode: "6287031250169" },
            "1006000035": { name: "ALBAIK SHRIMPS VALUE", barcode: "6287031250176" },
            "1006000036": { name: "ALBAIK SANDWICH SHRIMPS", barcode: "6287031250183" },
            "1006000037": { name: "ALBAIK HOMMOS DIP PORTION", barcode: "6287031250282" },
            "1006000038": { name: "ALBAIK GARLIC SMALL PORTION", barcode: "6287031250299" },
            "1006000039": { name: "ALBAIK GARLIC LARGE PORTION", barcode: "6287031250305" },
            "1006000040": { name: "ALBAIK COCKTAIL SMALL PORTION", barcode: "6287031250312" },
            "1006000041": { name: "ALBAIK COCKTAIL LARGE PORTION", barcode: "6287031250329" },
            "1006000042": { name: "ALBAIK NUGGETS SAUCE PORTION", barcode: "6287031250336" },
            "1006000043": { name: "ALBAIK GARLIC SUPER SAUCE", barcode: "6287031250343" },
            "1006000044": { name: "ALBAIK SHRIMPS / CFB SUPER SAUCE", barcode: "6287031250350" },
            "1006000045": { name: "ALBAIK LIGHT TARTAR SAUCE", barcode: "6287031250367" },
            "1006000046": { name: "ALBAIK FISH SUPER SAUCE", barcode: "6287031250374" },
            "1006000048": { name: "ALBAIK COLESLAW SAUCE", barcode: "6287031250398" },
            "1006000049": { name: "ALBAIK CFB SPICY SUPER SAUCE", barcode: "6287031250404" },
            "1006000050": { name: "ALBAIK COLESLAW PORTION", barcode: "6287031250411" },
            "1006000051": { name: "ALBAIK COLESLAW VEGETABLES SANDWICH", barcode: "6287031250428" },
            "1006000052": { name: "ALBAIK COLESLAW VEGETABLES BULK", barcode: "6287031250435" },
            "1006000053": { name: "ALBAIK PICKLES CUCUMBER", barcode: "6287031250442" },
            "1006000054": { name: "ALBAIK PICKLES CUCUMBER SPICY", barcode: "6287031250466" },
            "1006000055": { name: "ALBAIK PICKLES CUCUMBER SWEET", barcode: "6287031250459" },
            "1006000056": { name: "ALBAIK GCF SAUCE", barcode: "6287031250473" },
            "1006000057": { name: "ALBAIK FROZEN CHICKEN FILLET", barcode: "6287031250183" },
            "1006000094": { name: "ALBAIK Falafel Super Fillet", barcode: "6287031250220" },
            "1006000095": { name: "ALBAIK Marinated Chicken Strips", barcode: "6287031250206" },
            "1006000099": { name: "ALBAIK MARINATED CHICKEN STRIPS SPICY", barcode: "6287031250213" },
            "1006000125": { name: "ALBAIK Falafel Nuggets", barcode: "6287031250237" },
            "1006000196": { name: "ALBAIK Boneless Thighs Breaded", barcode: "6287031250619" },
            "1006000197": { name: "ALBAIK Boneless Drumsticks Breaded", barcode: "6287031250602" },
            "1006000198": { name: "ALBAIK Chicken Strips Breaded", barcode: "6287031250664" }
        };

        const CORRECTIVE_CATALOG = {
            "1006000215": { name: "ALBAIK Light Tartar Sauce", barcode: "6287031251135" },
            "1006000216": { name: "ALBAIK Pickles Cucumber Diced Sweet", barcode: "6287031251173" },
            "1006000217": { name: "ALBAIK Shrimps Value TL", barcode: "" },
            "941110": { name: "ketchup sachets", barcode: "6287031250480" },
            "930100": { name: "Ice-Cream Souse, Chocolate - Bottle 1 ltr", barcode: "6287031250497" },
            "930200": { name: "Ice-Cream Souse, Strawberry -Bottle 1 ltr", barcode: "6287031250503" },
            "910005": { name: "Pepsi - can-330 ml", barcode: "6281033000013" },
            "910009": { name: "Soft Drinks", barcode: "" }
        };

        const dom = {
            imageUploadInput: document.getElementById('image-upload-input'),
            cameraBtn: document.getElementById('camera-btn'),
            resultsTableBody: document.getElementById('results-table-body'),
            noDataMsg: document.getElementById('no-data-msg'),
            jsonBtn: document.getElementById('json-btn'),
            pdfBtn: document.getElementById('pdf-btn'),
            csvBtn: document.getElementById('csv-btn'),
            clearBtn: document.getElementById('clear-btn'),
            cameraModal: document.getElementById('camera-modal'),
            cameraVideo: document.getElementById('camera-video'),
            captureBtn: document.getElementById('capture-btn'),
            closeCameraBtn: document.getElementById('close-camera-btn'),
            processCanvas: document.getElementById('process-canvas'),
            toastContainer: document.getElementById('toast-container'),
            jsonModal: document.getElementById('json-modal'),
            closeJsonBtn: document.getElementById('close-json-btn'),
            downloadJsonFinalBtn: document.getElementById('download-json-final-btn'),
            jsonTempMin: document.getElementById('json-temp-min'),
            jsonTempMax: document.getElementById('json-temp-max'),
            jsonStartIndex: document.getElementById('json-start-index'),
            settingsBtn: document.getElementById('settings-btn'),
            demoIndicator: document.getElementById('demo-indicator')
        };

        // --- Logic ---
        function showToast(msg, type = 'success') {
            const t = document.createElement('div');
            t.className = `toast ${type}`;
            t.innerHTML = `<span class="text-sm font-medium">${msg}</span>`;
            dom.toastContainer.appendChild(t);
            setTimeout(() => { t.style.opacity='0'; setTimeout(()=>t.remove(),300); }, 3000);
        }

        // --- Mock Generator (CRITICAL for "No API" mode) ---
        function generateMockData() {
            // Merge catalogs to pick a valid random item
            const all = { ...DROPDOWN_CATALOG, ...CORRECTIVE_CATALOG };
            const keys = Object.keys(all);
            const k = keys[Math.floor(Math.random() * keys.length)];
            const prod = all[k];
            const today = new Date();
            const format = d => `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()}`;
            
            return {
                productCode: k,
                productName: prod.name,
                barcode: prod.barcode || "628" + Math.floor(Math.random() * 10000000000),
                productionDate: format(today),
                expiryDate: format(new Date(today.setMonth(today.getMonth()+6))),
                batchNumber: "BN" + Math.floor(Math.random() * 99999)
            };
        }

        function identifyProduct(code, barcode, name) {
            if (DROPDOWN_CATALOG[code]) return { ...DROPDOWN_CATALOG[code], code, type: 'dropdown' };
            for(let k in DROPDOWN_CATALOG) if(DROPDOWN_CATALOG[k].barcode === barcode) return { ...DROPDOWN_CATALOG[k], code: k, type: 'dropdown' };
            if (CORRECTIVE_CATALOG[code]) return { ...CORRECTIVE_CATALOG[code], code, type: 'corrective' };
            for(let k in CORRECTIVE_CATALOG) if(CORRECTIVE_CATALOG[k].barcode === barcode) return { ...CORRECTIVE_CATALOG[k], code: k, type: 'corrective' };
            return { name: name || "Unknown", code: code || "", type: 'corrective' };
        }

        async function processImage(id, base64) {
            const row = document.getElementById(id);
            row.querySelector('.status-cell').innerHTML = '<div class="loader"></div>';
            
            let result;
            const key = localStorage.getItem("gemini_api_key");

            if (!key) {
                // Simulate delay for realism
                await new Promise(r => setTimeout(r, 800));
                result = generateMockData();
            } else {
                try {
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${key}`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            contents: [{ parts: [{text: "Extract: Code, Name, Barcode, Prod Date(DD/MM/YYYY), Exp Date, Batch"}, {inlineData: {mimeType: "image/jpeg", data: base64}}] }],
                            generationConfig: { responseMimeType: "application/json" }
                        })
                    });
                    if (res.ok) {
                        const data = await res.json();
                        result = JSON.parse(data.candidates[0].content.parts[0].text);
                    } else {
                        throw new Error("API Failed");
                    }
                } catch(e) {
                    console.warn("API Error, Mocking", e);
                    result = generateMockData(); // Fallback on failure
                }
            }

            // Identify type (Dropdown vs Corrective)
            const info = identifyProduct(result.productCode, result.barcode, result.productName);
            
            // Populate row
            const inputs = row.querySelectorAll('input');
            inputs[0].value = info.code;
            inputs[1].value = info.name;
            inputs[2].value = result.barcode || info.barcode;
            inputs[3].value = result.productionDate || '';
            inputs[4].value = result.expiryDate || '';
            inputs[5].value = result.batchNumber || '';
            
            row.dataset.type = info.type; // Critical for JSON generation
            row.dataset.code = info.code;
            row.dataset.status = 'success';
            row.querySelector('.status-cell').innerHTML = '<span class="text-green-500 font-bold">OK</span>';
            
            // Enable actions
            ['json','csv','pdf'].forEach(b => dom[b+'Btn'].disabled = false);
        }

        // --- JSON Generator ---
        function downloadJSON() {
            let idx = parseInt(dom.jsonStartIndex.value) || 11;
            const fMin = parseFloat(dom.jsonTempMin.value), fMax = parseFloat(dom.jsonTempMax.value);
            const rows = Array.from(dom.resultsTableBody.querySelectorAll('tr[data-status="success"]'));
            
            if(!rows.length) return showToast("No valid data", "error");

            const items = rows.map(r => {
                const i = r.querySelectorAll('input');
                return { code: i[0].value, name: i[1].value, pDate: i[3].value, eDate: i[4].value, batch: i[5].value, type: r.dataset.type };
            });

            const frozen = items.filter(i => !CHILLED_CODES.includes(i.code));
            const chilled = items.filter(i => CHILLED_CODES.includes(i.code));
            
            // Assign IDs
            frozen.forEach(i => i.rid = idx++);
            chilled.forEach(i => i.rid = idx++);

            const cmds = [];
            const add = (list, tVar, trVar, minT, maxT) => {
                // Batch Fills
                list.forEach(i => cmds.push({ "Command": "type", "Target": `id=r${i.rid}_Time`, "Value": tVar }));
                list.forEach(i => cmds.push({ "Command": "type", "Target": `id=r${i.rid}_Temp_Truck`, "Value": trVar }));
                list.forEach(i => cmds.push({ "Command": "type", "Target": `id=r${i.rid}_Temp_Product`, "Value": (Math.random()*(maxT-minT)+minT).toFixed(1)+"C" }));
                // Details
                list.forEach(i => {
                    const r = i.rid;
                    if(i.type === 'dropdown') {
                        cmds.push({ "Command": "select", "Target": `id=r${r}_Product_Name`, "Value": `label=${i.name}` });
                        cmds.push({ "Command": "type", "Target": `id=r${r}_Corrective_Action`, "Value": "" });
                    } else {
                        cmds.push({ "Command": "type", "Target": `id=r${r}_Corrective_Action`, "Value": i.name });
                    }
                    cmds.push({ "Command": "type", "Target": `id=datepicker${r}`, "Value": i.pDate });
                    cmds.push({ "Command": "type", "Target": `id=datepicker${r+100}`, "Value": i.eDate });
                    cmds.push({ "Command": "type", "Target": `id=r${r}_Product_Lot`, "Value": i.batch });
                });
            };

            if (frozen.length) {
                cmds.push({ "Command": "prompt", "Target": "Time- Frozen", "Value": "timefrozen" });
                cmds.push({ "Command": "prompt", "Target": "Temp- Frozen", "Value": "tempfrozen" });
                add(frozen, "${timefrozen}", "${tempfrozen}", fMin, fMax);
            }
            if (chilled.length) {
                cmds.push({ "Command": "prompt", "Target": "Time- Chiller", "Value": "timechiller" });
                cmds.push({ "Command": "prompt", "Target": "Temp- Chiller", "Value": "tempchiller" });
                add(chilled, "${timechiller}", "${tempchiller}", 0.5, 4.8);
            }

            const blob = new Blob([JSON.stringify({ "Name": "FOOD PACKIGINE", "CreationDate": new Date().toISOString().split('T')[0], "Commands": cmds }, null, 2)]);
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = "automation.json"; a.click();
            dom.jsonModal.classList.add('hidden');
        }

        // --- Handlers ---
        dom.imageUploadInput.onchange = (e) => {
            Array.from(e.target.files).forEach(f => {
                const reader = new FileReader();
                reader.onload = (ev) => {
                    const id = 'row-' + Date.now() + Math.random();
                    const tr = dom.resultsTableBody.insertRow();
                    tr.id = id;
                    tr.className = "hover:bg-gray-50 transition-colors";
                    tr.innerHTML = `<td class="px-4 py-3"><img src="${ev.target.result}" class="h-10 w-10 rounded object-cover"></td>${Array(6).fill('<td class="px-4 py-3"><input class="editable-input" placeholder="-"></td>').join('')}<td class="px-4 py-3 status-cell text-xs text-gray-500">Wait</td>`;
                    dom.noDataMsg.style.display = 'none';
                    processImage(id, ev.target.result.split(',')[1]);
                };
                reader.readAsDataURL(f);
            });
            e.target.value = '';
        };

        dom.clearBtn.onclick = () => { dom.resultsTableBody.innerHTML = ''; dom.noDataMsg.style.display = 'block'; ['json','csv','pdf'].forEach(b => dom[b+'Btn'].disabled=true); };
        dom.jsonBtn.onclick = () => dom.jsonModal.classList.remove('hidden');
        dom.closeJsonBtn.onclick = () => dom.jsonModal.classList.add('hidden');
        dom.downloadJsonFinalBtn.onclick = downloadJSON;
        
        dom.settingsBtn.onclick = () => {
            const k = prompt("API Key (Empty for Demo):", localStorage.getItem("gemini_api_key")||"");
            if (k!==null) { k ? localStorage.setItem("gemini_api_key", k) : localStorage.removeItem("gemini_api_key"); location.reload(); }
        };

        if(!localStorage.getItem("gemini_api_key")) dom.demoIndicator.classList.remove('hidden');
    });
    </script>
</body>
</html>


