<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Product Data Extractor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- jsPDF Core Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- jsPDF AutoTable plugin for creating tables in PDFs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .loader {
            border: 2px solid #e5e7eb;
            border-top: 2px solid #4f46e5;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #camera-modal, #json-modal {
            background-color: rgba(0,0,0,0.85);
            backdrop-filter: blur(4px);
        }
        /* Removed scaleX(-1) so rear camera text is readable */
        #camera-video {
            object-fit: cover;
        }
        #flash-overlay.flash {
            animation: flash-animation 0.3s ease-out;
        }
        @keyframes flash-animation {
            from { opacity: 0.7; }
            to { opacity: 0; }
        }
        .editable-input {
            width: 100%;
            border: 1px solid transparent;
            padding: 6px 8px;
            border-radius: 6px;
            background-color: transparent;
            transition: all 0.2s ease-in-out;
        }
        .editable-input:hover {
            background-color: #f9fafb;
            border-color: #d1d5db;
        }
        .editable-input:focus {
            outline: 2px solid transparent;
            outline-offset: 2px;
            border-color: #4f46e5;
            background-color: #ffffff;
            box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.5);
        }
        .status-icon {
            width: 20px;
            height: 20px;
            margin-right: 8px;
        }
        .retry-btn {
            background-color: #4f46e5;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 4px 10px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
            margin-left: 8px;
        }
        .retry-btn:hover {
            background-color: #4338ca;
        }
        .retry-btn:disabled {
            background-color: #a5b4fc;
            cursor: not-allowed;
        }
        /* Custom Toast Notification */
        #toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }
        .toast {
            background: white;
            padding: 12px 24px;
            border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            margin-top: 10px;
            display: flex;
            align-items: center;
            animation: slideIn 0.3s ease-out;
            border-left: 4px solid #4f46e5;
            max-width: 300px;
        }
        .toast.error { border-left-color: #ef4444; }
        .toast.success { border-left-color: #10b981; }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
    </style>
</head>
<body class="antialiased text-gray-800">

    <div class="container mx-auto max-w-6xl p-4 md:p-8">
        <div class="bg-white rounded-2xl shadow-xl p-6 md:p-8 border border-gray-100">
            <div class="text-center mb-8">
                <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-indigo-100 text-indigo-600 mb-4">
                    <i class="fas fa-magic text-2xl"></i>
                </div>
                <h1 class="text-3xl md:text-4xl font-bold text-gray-900 tracking-tight">Smart Product Data Extractor</h1>
                <p class="text-gray-500 mt-3 text-lg">Automatically extract product details via Code Lookup or AI label reading.</p>
            </div>
            
            <div id="notification-area" class="text-center text-sm font-medium h-6 mb-4 transition-colors duration-300"></div>

            <div class="flex flex-col sm:flex-row justify-center items-center gap-4 mb-8">
                <label for="image-upload-input" class="w-full sm:w-auto cursor-pointer inline-flex justify-center items-center py-3 px-6 border border-transparent shadow-sm text-sm font-medium rounded-lg text-white bg-indigo-600 hover:bg-indigo-700 transition-all transform hover:-translate-y-0.5 active:translate-y-0">
                    <i class="fas fa-upload mr-2"></i>
                    Upload Images
                </label>
                <input id="image-upload-input" type="file" class="hidden" accept="image/*" multiple>
                
                <button id="camera-btn" class="w-full sm:w-auto inline-flex justify-center items-center py-3 px-6 border border-gray-300 shadow-sm text-sm font-medium rounded-lg text-gray-700 bg-white hover:bg-gray-50 transition-all transform hover:-translate-y-0.5 active:translate-y-0">
                    <i class="fas fa-camera mr-2"></i>
                    Use Camera
                </button>
            </div>

            <div class="overflow-hidden bg-gray-50 rounded-xl border border-gray-200">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-100">
                            <tr>
                                <th scope="col" class="px-6 py-4 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Preview</th>
                                <th scope="col" class="px-6 py-4 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Prod. Code</th>
                                <th scope="col" class="px-6 py-4 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Product Name</th>
                                <th scope="col" class="px-6 py-4 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Barcode</th>
                                <th scope="col" class="px-6 py-4 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Prod. Date</th>
                                <th scope="col" class="px-6 py-4 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Expiry Date</th>
                                <th scope="col" class="px-6 py-4 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Batch No.</th>
                                <th scope="col" class="px-6 py-4 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Status</th>
                            </tr>
                        </thead>
                        <tbody id="results-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                    </table>
                </div>
                 
                 <div id="no-data-msg" class="text-center text-gray-500 py-16">
                    <div class="mx-auto h-12 w-12 text-gray-300 mb-3">
                        <i class="far fa-images text-5xl"></i>
                    </div>
                    <h3 class="mt-2 text-sm font-medium text-gray-900">No images added</h3>
                    <p class="mt-1 text-sm text-gray-500">Get started by uploading an image or using the camera.</p>
                 </div>
            </div>
            
            <div class="mt-8 flex flex-col sm:flex-row justify-end gap-3 pt-6 border-t border-gray-100">
                 <button id="json-btn" class="w-full sm:w-auto inline-flex justify-center items-center py-2.5 px-5 border border-transparent shadow-sm text-sm font-medium rounded-lg text-white bg-indigo-600 hover:bg-indigo-700 disabled:bg-indigo-300 disabled:cursor-not-allowed transition-colors" disabled>
                     <i class="fas fa-code mr-2"></i> Automation JSON
                 </button>
                 <button id="csv-btn" class="w-full sm:w-auto inline-flex justify-center items-center py-2.5 px-5 border border-transparent shadow-sm text-sm font-medium rounded-lg text-white bg-emerald-600 hover:bg-emerald-700 disabled:bg-emerald-300 disabled:cursor-not-allowed transition-colors" disabled>
                     <i class="fas fa-file-csv mr-2"></i> Export to CSV
                 </button>
                 <button id="pdf-btn" class="w-full sm:w-auto inline-flex justify-center items-center py-2.5 px-5 border border-transparent shadow-sm text-sm font-medium rounded-lg text-white bg-red-600 hover:bg-red-700 disabled:bg-red-300 disabled:cursor-not-allowed transition-colors" disabled>
                     <i class="fas fa-file-pdf mr-2"></i> Generate PDF
                 </button>
                 <button id="clear-btn" class="w-full sm:w-auto inline-flex justify-center items-center py-2.5 px-5 border border-gray-300 shadow-sm text-sm font-medium rounded-lg text-gray-700 bg-white hover:bg-gray-50 transition-colors">
                     Clear All
                 </button>
            </div>
        </div>
    </div>

    <!-- Camera Modal -->
    <div id="camera-modal" class="fixed inset-0 z-50 items-center justify-center hidden p-4">
        <div class="bg-white rounded-2xl shadow-2xl overflow-hidden max-w-lg w-full relative flex flex-col max-h-[90vh]">
            <div class="relative bg-black flex-grow flex items-center justify-center overflow-hidden">
                <video id="camera-video" class="w-full h-full" autoplay playsinline></video>
                <div id="flash-overlay" class="absolute inset-0 bg-white opacity-0 pointer-events-none"></div>
            </div>
            <div class="p-6 bg-white flex justify-center gap-6">
                <button id="close-camera-btn" class="py-3 px-6 bg-gray-100 text-gray-700 font-medium rounded-full hover:bg-gray-200 transition-colors min-w-[100px]">Cancel</button>
                <button id="capture-btn" class="py-3 px-6 bg-indigo-600 text-white font-medium rounded-full hover:bg-indigo-700 shadow-lg shadow-indigo-200 transition-all transform active:scale-95 min-w-[100px] flex items-center justify-center">
                    <i class="fas fa-camera mr-2"></i> Capture
                </button>
            </div>
        </div>
    </div>
    
    <!-- JSON Settings Modal -->
    <div id="json-modal" class="fixed inset-0 z-50 items-center justify-center hidden p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6 animate-[slideIn_0.2s_ease-out]">
            <h3 class="text-xl font-bold text-gray-900 mb-5">Automation Settings</h3>
            
            <div class="space-y-5">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Start Row Index</label>
                    <input type="number" id="json-start-index" value="1" min="1" class="w-full border-gray-300 bg-gray-50 rounded-lg shadow-sm border p-2.5 focus:ring-indigo-500 focus:border-indigo-500 outline-none">
                    <p class="text-xs text-gray-500 mt-1">IDs will start counting from this number (e.g., r1, datepicker1).</p>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Global Time</label>
                    <input type="time" id="json-time" value="10:20" class="w-full border-gray-300 bg-gray-50 rounded-lg shadow-sm border p-2.5 focus:ring-indigo-500 focus:border-indigo-500 outline-none">
                    <p class="text-xs text-gray-500 mt-1">This time will be applied to all entries.</p>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Truck Temperature</label>
                    <input type="text" id="json-truck-temp" value="-18.2C" class="w-full border-gray-300 bg-gray-50 rounded-lg shadow-sm border p-2.5 focus:ring-indigo-500 focus:border-indigo-500 outline-none">
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Prod. Temp Min</label>
                        <input type="number" id="json-temp-min" value="-18.5" step="0.1" class="w-full border-gray-300 bg-gray-50 rounded-lg shadow-sm border p-2.5 focus:ring-indigo-500 focus:border-indigo-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Prod. Temp Max</label>
                        <input type="number" id="json-temp-max" value="-17.0" step="0.1" class="w-full border-gray-300 bg-gray-50 rounded-lg shadow-sm border p-2.5 focus:ring-indigo-500 focus:border-indigo-500 outline-none">
                    </div>
                </div>
                 <p class="text-xs text-gray-500 italic border-l-2 border-indigo-400 pl-2">Product temperature will be randomized between Min and Max for each item.</p>
            </div>

            <div class="mt-8 flex justify-end gap-3">
                <button id="close-json-btn" class="px-5 py-2.5 bg-gray-100 text-gray-700 font-medium rounded-lg hover:bg-gray-200 transition-colors">Cancel</button>
                <button id="download-json-final-btn" class="px-5 py-2.5 bg-indigo-600 text-white font-medium rounded-lg hover:bg-indigo-700 shadow-lg shadow-indigo-200 transition-colors flex items-center">
                    <i class="fas fa-download mr-2"></i> Download JSON
                </button>
            </div>
        </div>
    </div>

    <canvas id="camera-canvas" class="hidden"></canvas>
    <div id="toast-container"></div>

    <script>
        // Use global scope for jsPDF since it's loaded via CDN
        const { jsPDF } = window.jspdf;

        // --- Product Catalog Definition ---
        const PRODUCT_CATALOG = {
            "1006000003": "ALBAIK CHICKEN SPICY MARINATED",
            "1006000020": "ALBAIK CHICKEN FILLET NUGGETS",
            "1006000021": "ALBAIK CHICKEN FILLET NUGGETS SPICY",
            "1006000022": "ALBAIK CHICKEN FILLET SUPER",
            "1006000023": "ALBAIK CHICKEN FILLET SUPER SPICY",
            "1006000024": "ALBAIK CHICKEN FINGER",
            "1006000025": "ALBAIK CHICKEN FILLET NUGGETS HAJJ",
            "1006000026": "ALBAIK CHICKEN FILLET BURGER",
            "1006000027": "ALBAIK CHICKEN FILLET BURGER SPICY",
            "1006000028": "ALBAIK CHICKEN FILLET SUPER XT",
            "1006000029": "ALBAIK CHICKEN FILLET SUPER SPICY XT",
            "1006000030": "ALBAIK FISH FILLET NUGGETS",
            "1006000031": "ALBAIK FISH FILLET SUPER",
            "1006000032": "ALBAIK FISH FILLET NUGGETS SPICY",
            "1006000033": "ALBAIK FISH FILLET SUPER SPICY",
            "1006000034": "ALBAIK SHRIMPS JUMBO",
            "1006000035": "ALBAIK SHRIMPS VALUE",
            "1006000036": "ALBAIK SANDWICH SHRIMPS",
            "1006000037": "ALBAIK HOMMOS DIP PORTION",
            "1006000038": "ALBAIK GARLIC SMALL PORTION",
            "1006000039": "ALBAIK GARLIC LARGE PORTION",
            "1006000040": "ALBAIK COCKTAIL SMALL PORTION",
            "1006000041": "ALBAIK COCKTAIL LARGE PORTION",
            "1006000042": "ALBAIK NUGGETS SAUCE PORTION",
            "1006000043": "ALBAIK GARLIC SUPER SAUCE",
            "1006000044": "ALBAIK SHRIMPS / CFB SUPER SAUCE",
            "1006000045": "ALBAIK LIGHT TARTAR SAUCE",
            "1006000046": "ALBAIK FISH SUPER SAUCE",
            "1006000048": "ALBAIK COLESLAW SAUCE",
            "1006000049": "ALBAIK CFB SPICY SUPER SAUCE",
            "1006000050": "ALBAIK COLESLAW PORTION",
            "1006000051": "ALBAIK COLESLAW VEGETABLES SANDWICH",
            "1006000052": "ALBAIK COLESLAW VEGETABLES BULK",
            "1006000053": "ALBAIK PICKLES CUCUMBER",
            "1006000054": "ALBAIK PICKLES CUCUMBER SPICY",
            "1006000055": "ALBAIK PICKLES CUCUMBER SWEET",
            "1006000056": "ALBAIK GCF SAUCE",
            "941110": "ketchup sachets",
            "930100": "Ice-Cream Souse, Chocolate - Bottle 1 ltr",
            "930200": "Ice-Cream Souse, Strawberry -Bottle 1 ltr",
            "910005": "Pepsi - can-330 ml",
            "910006": "Pepsi - Diet -can 330 ml",
            "910007": "Miranda -can -330 ml",
            "910008": "7 up -can -330 ml",
            "910009": "Soft Drinks",
            "910120": "Pepsi - Ordinary -Bottle 400 ml",
            "910121": "Pepsi - Diet -Bottle 400 ml",
            "910122": "Miranda -Ordinary -Bottle 400 ml",
            "910123": "7 up - Ordinary -Bottle 400 ml",
            "912479": "Citrus -can -330 ml",
            "910004": "Lipton Ice Tea-can",
            "911120": "Fresh Orange almarai Juice 200 ml",
            "911121": "Fresh Apple almarai Juice 200 ml",
            "911122": "Fresh mango almarai Juice 200 ml",
            "911123": "Fresh Mix Fruit almarai Juice 200 ml",
            "911124": "Fresh mix berry almarai Juice 200 ml",
            "911130": "Fresh Orange with pulp almarai Juice 300 ml",
            "911131": "Fresh Mango with pulp almarai Juice 300 ml",
            "911132": "Fresh Apple almarai Juice 300 ml",
            "911133": "Fresh Straberry almarai juice 300 ml",
            "911134": "Fresh Fruit Cocktail almarai juice 300 ml",
            "913000": "Mineral Water (For sale)- Bottle 0.6ltr",
            "913100": "Mineral water (For free) - Bottle 19ltr"
        };

        const dom = {
            imageUploadInput: document.getElementById('image-upload-input'),
            cameraBtn: document.getElementById('camera-btn'),
            resultsTableBody: document.getElementById('results-table-body'),
            noDataMsg: document.getElementById('no-data-msg'),
            pdfBtn: document.getElementById('pdf-btn'),
            csvBtn: document.getElementById('csv-btn'),
            jsonBtn: document.getElementById('json-btn'),
            clearBtn: document.getElementById('clear-btn'),
            notificationArea: document.getElementById('notification-area'),
            cameraModal: document.getElementById('camera-modal'),
            cameraVideo: document.getElementById('camera-video'),
            captureBtn: document.getElementById('capture-btn'),
            closeCameraBtn: document.getElementById('close-camera-btn'),
            cameraCanvas: document.getElementById('camera-canvas'),
            flashOverlay: document.getElementById('flash-overlay'),
            toastContainer: document.getElementById('toast-container'),
            // JSON Modal elements
            jsonModal: document.getElementById('json-modal'),
            closeJsonBtn: document.getElementById('close-json-btn'),
            downloadJsonFinalBtn: document.getElementById('download-json-final-btn'),
            jsonTime: document.getElementById('json-time'),
            jsonTruckTemp: document.getElementById('json-truck-temp'),
            jsonTempMin: document.getElementById('json-temp-min'),
            jsonTempMax: document.getElementById('json-temp-max'),
            jsonStartIndex: document.getElementById('json-start-index')
        };

        let mediaStream = null;
        const imageQueue = [];
        let activeProcessingCount = 0;
        const MAX_CONCURRENT_REQUESTS = 3;

        // --- Helper: Toast Notification ---
        function showToast(message, type = 'default') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<span class="text-sm font-medium">${message}</span>`;
            
            dom.toastContainer.appendChild(toast);

            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100%)';
                toast.addEventListener('transitionend', () => toast.remove());
            }, 3000);
        }

        // --- Core Logic ---
        async function handleImageCapture(base64Data, dataUrl) {
            dom.notificationArea.textContent = '';
            dom.notificationArea.className = 'text-center text-sm font-medium h-6 mb-4';

            const id = `img-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
            dom.noDataMsg.style.display = 'none';
            addTableRow(id, dataUrl, base64Data);
            imageQueue.push({ id, base64Data });
            processQueue();
        }

        function processQueue() {
            while (activeProcessingCount < MAX_CONCURRENT_REQUESTS && imageQueue.length > 0) {
                activeProcessingCount++;
                const { id, base64Data } = imageQueue.shift();
                
                updateTableRowStatus(id, 'processing');

                callGeminiAPI(base64Data)
                    .then(result => {
                        // --- Post-Processing Lookup Logic ---
                        if (result) {
                            // Normalize Code: Remove whitespace
                            const rawCode = result.productCode ? result.productCode.trim() : "";
                            
                            // Check if code exists in catalog
                            if (rawCode && PRODUCT_CATALOG[rawCode]) {
                                result.productName = PRODUCT_CATALOG[rawCode];
                            }
                        }
                        
                        updateTableRowData(id, result || {}, result ? 'success' : 'failed');
                        if (result) {
                            dom.pdfBtn.disabled = false;
                            dom.csvBtn.disabled = false;
                            dom.jsonBtn.disabled = false;
                            showToast('Data extracted successfully', 'success');
                        } else {
                            showToast('Failed to extract data', 'error');
                        }
                    })
                    .catch(error => {
                        console.error('Error processing image:', error);
                        updateTableRowData(id, {}, 'failed');
                        showToast('Error processing image', 'error');
                    })
                    .finally(() => {
                        activeProcessingCount--;
                        processQueue();
                    });
            }
        }

        async function retryImageProcessing(id) {
            const row = document.getElementById(id);
            if (!row || !row.dataset.base64) return;

            const base64Data = row.dataset.base64;
            updateTableRowStatus(id, 'processing');

            try {
                const result = await callGeminiAPI(base64Data);
                
                if (result) {
                    const rawCode = result.productCode ? result.productCode.trim() : "";
                    if (rawCode && PRODUCT_CATALOG[rawCode]) {
                        result.productName = PRODUCT_CATALOG[rawCode];
                    }
                }

                updateTableRowData(id, result || {}, result ? 'success' : 'failed');
                 if (result) {
                    dom.pdfBtn.disabled = false;
                    dom.csvBtn.disabled = false;
                    dom.jsonBtn.disabled = false;
                    showToast('Retry successful', 'success');
                }
            } catch (error) {
                console.error('Error retrying image:', error);
                updateTableRowData(id, {}, 'failed');
                showToast('Retry failed', 'error');
            }
        }

        async function callGeminiAPI(imageData) {
             const apiKey = ""; // API Key injected by environment
             
             // Updated to the correct model name
             const modelName = "gemini-2.5-flash-preview-09-2025";
             const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKey}`;
             
             const detailedPrompt = `
                You are an expert product data extraction AI. Analyze the image to identify product details with high accuracy.
                
                Extract the following fields:
                1. Product Code: A distinct item code. Based on the catalog, these are often 10-digit numbers (starting with 1006...) or 6-digit numbers (9xxxxx). Look for labels like "Code", "Item No", or just the number on the label.
                2. Product Name: The full commercial name.
                3. Barcode: The EAN, UPC, or numeric code associated with the barcode (often below the vertical lines).
                4. Production Date: Look for "Mfg", "Prod", "P.Date", "Mfd".
                5. Expiry Date: Look for "Exp", "Use By", "Best Before", "BB".
                6. Batch Number: Look for "Batch", "Lot", "L/", "B/N".

                **Critical Rules:**
                - Product Code is CRITICAL. Try to find the number matching the patterns '1006xxxxxx' or '9xxxxx'.
                - Format dates strictly as DD/MM/YYYY.
                - If only one date is visible (future), it is Expiry.
                - If a value is not visible, return empty string.
             `;

             const payload = {
                 contents: [{ 
                     parts: [
                         { text: detailedPrompt }, 
                         { inlineData: { mimeType: "image/jpeg", data: imageData } }
                     ] 
                 }],
                 generationConfig: {
                     temperature: 0,
                     responseMimeType: "application/json",
                     responseSchema: {
                         type: "OBJECT",
                         properties: {
                             productCode: { type: "STRING" },
                             productName: { type: "STRING" },
                             barcode: { type: "STRING" },
                             productionDate: { type: "STRING" },
                             expiryDate: { type: "STRING" },
                             batchNumber: { type: "STRING" }
                         }
                     }
                 }
             };

             const delays = [1000, 2000, 4000];
             for (let i = 0; i <= delays.length; i++) {
                 try {
                     const response = await fetch(apiUrl, { 
                         method: 'POST', 
                         headers: { 'Content-Type': 'application/json' }, 
                         body: JSON.stringify(payload) 
                     });

                     if (response.ok) {
                         const result = await response.json();
                         let jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                         if (jsonText) {
                             jsonText = jsonText.replace(/```json|```/g, '').trim();
                             return JSON.parse(jsonText);
                         }
                         return null;
                     } 
                     
                     if (i === delays.length) {
                        const errorBody = await response.text();
                        throw new Error(`API Error: ${response.status} ${errorBody}`);
                     }

                 } catch (error) {
                     console.error(`Attempt ${i + 1} failed:`, error);
                     if (i < delays.length) {
                         await new Promise(res => setTimeout(res, delays[i]));
                     } else {
                         throw error;
                     }
                 }
             }
             return null;
        }

        // --- UI Functions ---
        function addTableRow(id, thumbnailUrl, base64Data) {
            const row = dom.resultsTableBody.insertRow();
            row.id = id;
            row.dataset.base64 = base64Data;
            row.className = "hover:bg-gray-50 transition-colors";
            row.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap">
                    <img src="${thumbnailUrl}" class="h-12 w-12 object-cover rounded-lg shadow-sm border border-gray-200">
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 data-cell italic" colspan="6">Waiting in queue...</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 status-cell"></td>
            `;
            updateTableRowStatus(id, 'queued');
        }
        
        function updateTableRowStatus(id, status) {
            const row = document.getElementById(id);
            if (!row) return;
            
            const statusCell = row.querySelector('.status-cell');
            row.dataset.status = status;
            
            let statusHtml = '';
            switch(status) {
                case 'queued':
                    statusHtml = `<div class="flex items-center text-gray-400"><i class="far fa-clock mr-2"></i>Queued</div>`;
                    break;
                case 'processing':
                    statusHtml = `<div class="flex items-center text-indigo-600 font-medium"><div class="loader mr-2"></div>Processing</div>`;
                    break;
            }
            if (statusCell && statusHtml) statusCell.innerHTML = statusHtml;
        }

        function updateTableRowData(id, data, status) {
            const row = document.getElementById(id);
            if (!row) return;

            row.dataset.status = status;
            const statusCell = row.querySelector('.status-cell');
            const dataCell = row.querySelector('.data-cell');
            
            if (dataCell) dataCell.remove();

            let statusHtml;
            if (status === 'success') {
                statusHtml = `<div class="flex items-center text-emerald-600 font-medium"><i class="fas fa-check-circle mr-2"></i>Success</div>`;
            } else {
                statusHtml = `<div class="flex items-center text-red-600 font-medium"><i class="fas fa-exclamation-circle mr-2"></i>Failed <button class="retry-btn shadow-sm">Retry</button></div>`;
            }

            const dataHtml = `
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"><input type="text" class="editable-input" value="${data.productCode || ''}" placeholder="--"></td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900"><input type="text" class="editable-input font-medium" value="${data.productName || ''}" placeholder="--"></td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900"><input type="text" class="editable-input" value="${data.barcode || ''}" placeholder="--"></td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"><input type="text" class="editable-input" value="${data.productionDate || ''}" placeholder="--"></td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"><input type="text" class="editable-input" value="${data.expiryDate || ''}" placeholder="--"></td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"><input type="text" class="editable-input" value="${data.batchNumber || ''}" placeholder="--"></td>
            `;
            
            const existingDataCells = row.querySelectorAll('td:not(:first-child):not(.status-cell)');
            existingDataCells.forEach(cell => cell.remove());

            const tempDiv = document.createElement('tr');
            tempDiv.innerHTML = dataHtml;
            const newCells = Array.from(tempDiv.cells);
            
            if (row.cells.length === 2 && row.cells[1].colSpan === 6) {
                 row.deleteCell(1);
            }

            newCells.forEach(cell => row.insertBefore(cell, statusCell));
            
            statusCell.innerHTML = statusHtml;
        }
        
        function generatePdf() {
            const doc = new jsPDF();
            const tableData = [];
            const headers = [['Product Code', 'Product Name', 'Barcode', 'Production Date', 'Expiry Date', 'Batch No.']];
            
            dom.resultsTableBody.querySelectorAll('tr').forEach(row => {
                if (row.dataset.status === 'success') {
                    const inputs = row.querySelectorAll('.editable-input');
                    if (inputs.length >= 6) {
                        tableData.push([
                            inputs[0].value, // Code
                            inputs[1].value, // Name
                            inputs[2].value, // Barcode
                            inputs[3].value, // Prod
                            inputs[4].value, // Exp
                            inputs[5].value  // Batch
                        ]);
                    }
                }
            });
            
            if (tableData.length === 0) {
                showToast("No data to generate PDF.", "error");
                return;
            }
            
            doc.setFontSize(18);
            doc.text("Product Data Report", 14, 15);
            doc.setFontSize(10);
            doc.text(`Generated on: ${new Date().toLocaleString()}`, 14, 22);
            
            doc.autoTable({ 
                head: headers, 
                body: tableData, 
                startY: 30,
                theme: 'grid',
                headStyles: { fillColor: [79, 70, 229] },
                styles: { fontSize: 8 }
            });
            doc.save('product-data-report.pdf');
            showToast("PDF generated successfully", "success");
        }

        function formatDateToMMDDYYYY(dateStr) {
            // Input expected: DD/MM/YYYY (from AI)
            // Output needed: MM/DD/YYYY (for JSON/CSV)
            if (!dateStr || !dateStr.includes('/')) return dateStr;
            const parts = dateStr.split('/');
            // If we have Day, Month, Year
            if (parts.length === 3) {
                return `${parts[1]}/${parts[0]}/${parts[2]}`;
            }
            return dateStr;
        }

        // --- JSON Generation Logic ---

        function openJsonSettings() {
            // Check if there are any successful rows
            let hasData = false;
            dom.resultsTableBody.querySelectorAll('tr').forEach(row => {
                if (row.dataset.status === 'success') hasData = true;
            });

            if (!hasData) {
                showToast("No data available to generate JSON.", "error");
                return;
            }

            dom.jsonModal.classList.remove('hidden');
            dom.jsonModal.classList.add('flex');
        }

        function closeJsonModal() {
            dom.jsonModal.classList.add('hidden');
            dom.jsonModal.classList.remove('flex');
        }

        function formatTime12Hour(timeStr) {
            if (!timeStr) return "10:00 AM";
            const [hours, minutes] = timeStr.split(':');
            let h = parseInt(hours);
            const ampm = h >= 12 ? 'PM' : 'AM';
            h = h % 12;
            h = h ? h : 12; // 0 should be 12
            return `${h}:${minutes} ${ampm}`;
        }

        function getRandomTemp(min, max) {
            const val = Math.random() * (max - min) + min;
            return val.toFixed(1) + "C";
        }

        function downloadJSON() {
            const globalTime = formatTime12Hour(dom.jsonTime.value);
            const globalTruckTemp = dom.jsonTruckTemp.value;
            const tempMin = parseFloat(dom.jsonTempMin.value);
            const tempMax = parseFloat(dom.jsonTempMax.value);
            // Use user-provided start index or default to 1
            let rowCount = parseInt(dom.jsonStartIndex.value) || 1;

            const commands = [];

            dom.resultsTableBody.querySelectorAll('tr').forEach(row => {
                if (row.dataset.status === 'success') {
                    const inputs = row.querySelectorAll('.editable-input');
                    if (inputs.length >= 6) {
                        const productName = inputs[1].value;
                        const prodDate = formatDateToMMDDYYYY(inputs[3].value);
                        const expDate = formatDateToMMDDYYYY(inputs[4].value);
                        const batchNo = inputs[5].value;

                        // Generate Random Temp for this row
                        const randomProductTemp = getRandomTemp(tempMin, tempMax);

                        // --- Generate Commands for this row ---
                        
                        // 1. Select Product Name
                        commands.push({
                            "Command": "select",
                            "Target": `id=r${rowCount}_Product_Name`,
                            "Value": `label=${productName}`,
                            "Targets": [
                                `id=r${rowCount}_Product_Name`,
                                `name=r${rowCount}_Product_Name`,
                                `xpath=//*[@id="r${rowCount}_Product_Name"]`,
                                `css=#r${rowCount}_Product_Name`
                            ],
                            "Description": ""
                        });

                        // 2. Production Date
                        const prodPickerId = `datepicker${rowCount}`;
                        commands.push({
                            "Command": "click",
                            "Target": `id=${prodPickerId}`,
                            "Value": prodDate,
                            "Targets": [
                                `id=${prodPickerId}`,
                                `name=r${rowCount}_Production_Date`,
                                `xpath=//*[@id="${prodPickerId}"]`,
                                `css=#${prodPickerId}`
                            ],
                            "Description": "production date"
                        });

                        // 3. Expiry Date (offset 10)
                        const expPickerId = `datepicker${rowCount + 10}`;
                        commands.push({
                            "Command": "click",
                            "Target": `id=${expPickerId}`,
                            "Value": expDate,
                            "Targets": [
                                `id=${expPickerId}`,
                                `name=r${rowCount}_expiry_Date`,
                                `xpath=//*[@id="${expPickerId}"]`,
                                `css=#${expPickerId}`
                            ],
                            "Description": "expire date"
                        });

                        // 4. Batch/Lot
                        commands.push({
                            "Command": "type",
                            "Target": `id=r${rowCount}_Product_Lot`,
                            "Value": batchNo,
                            "Targets": [
                                `id=r${rowCount}_Product_Lot`,
                                `name=r${rowCount}_Product_Lot`,
                                `xpath=//*[@id="r${rowCount}_Product_Lot"]`,
                                `css=#r${rowCount}_Product_Lot`
                            ],
                            "Description": ""
                        });

                        // 5. Temp Truck (Customized)
                        commands.push({
                            "Command": "type",
                            "Target": `id=r${rowCount}_Temp_Truck`,
                            "Value": globalTruckTemp,
                            "Targets": [
                                `id=r${rowCount}_Temp_Truck`,
                                `name=r${rowCount}_Temp_Truck`,
                                `xpath=//*[@id="r${rowCount}_Temp_Truck"]`,
                                `css=#r${rowCount}_Temp_Truck`
                            ],
                            "Description": ""
                        });

                        // 6. Temp Product (Randomized)
                         commands.push({
                            "Command": "type",
                            "Target": `id=r${rowCount}_Temp_Product`,
                            "Value": randomProductTemp,
                            "Targets": [
                                `id=r${rowCount}_Temp_Product`,
                                `name=r${rowCount}_Temp_Product`,
                                `xpath=//*[@id="r${rowCount}_Temp_Product"]`,
                                `css=#r${rowCount}_Temp_Product`
                            ],
                            "Description": ""
                        });

                        // 7. REMOVED Quantity (Deleted as per request)

                        // 8. Corrective Action (Smart Logic)
                        // Check if product name exists in the provided catalog
                        const cleanName = productName.trim();
                        const isKnownProduct = Object.values(PRODUCT_CATALOG).some(name => name === cleanName);
                        // If NOT found, use name as ID. If found, leave empty.
                        const correctiveValue = isKnownProduct ? "" : cleanName;

                         commands.push({
                            "Command": "type",
                            "Target": `id=r${rowCount}_Corrective_Action`,
                            "Value": correctiveValue,
                            "Targets": [
                                `id=r${rowCount}_Corrective_Action`,
                                `name=r${rowCount}_Corrective_Action`,
                                `xpath=//*[@id="r${rowCount}_Corrective_Action"]`,
                                `css=#r${rowCount}_Corrective_Action`
                            ],
                            "Description": ""
                        });

                        // 9. Time (Customized)
                         commands.push({
                            "Command": "type",
                            "Target": `id=r${rowCount}_Time`,
                            "Value": globalTime,
                            "Targets": [
                                `id=r${rowCount}_Time`,
                                `name=r${rowCount}_Time`,
                                `xpath=//*[@id="r${rowCount}_Time"]`,
                                `css=#r${rowCount}_Time`
                            ],
                            "Description": ""
                        });

                        rowCount++;
                    }
                }
            });

            const finalJson = {
                "Name": "FOOD PACKIGINE",
                "CreationDate": new Date().toISOString().split('T')[0],
                "Commands": commands
            };

            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(finalJson, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "automation_script.json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
            
            closeJsonModal();
            showToast("JSON generated successfully", "success");
        }

        function generateCSV() {
            let csvContent = "data:text/csv;charset=utf-8,";
            const headers = ['Product Code', 'Product Name', 'Barcode', 'Production Date', 'Expiry Date', 'Batch No.'];
            csvContent += headers.join(",") + "\r\n";

            let rowsFound = 0;
            dom.resultsTableBody.querySelectorAll('tr').forEach(row => {
                if (row.dataset.status === 'success') {
                    rowsFound++;
                    const inputs = row.querySelectorAll('.editable-input');
                    if (inputs.length >= 6) {
                        // Convert dates from DD/MM/YYYY to MM/DD/YYYY
                        const prodDate = formatDateToMMDDYYYY(inputs[3].value);
                        const expDate = formatDateToMMDDYYYY(inputs[4].value);

                        const rowData = [
                            `"${inputs[0].value.replace(/"/g, '""')}"`, // Code
                            `"${inputs[1].value.replace(/"/g, '""')}"`, // Name
                            `"${inputs[2].value.replace(/"/g, '""')}"`, // Barcode
                            `"${prodDate}"`,
                            `"${expDate}"`,
                            `"${inputs[5].value}"` // Batch
                        ];
                        csvContent += rowData.join(",") + "\r\n";
                    }
                }
            });

            if (rowsFound === 0) {
                showToast("No data to export.", "error");
                return;
            }
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "product_data_export.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showToast("CSV exported successfully", "success");
        }

        function closeCamera() {
            if (mediaStream) {
                mediaStream.getTracks().forEach(track => track.stop());
                mediaStream = null;
            }
            dom.cameraModal.classList.add('hidden');
            dom.cameraModal.classList.remove('flex');
        }

        // --- Event Listeners ---
        
        dom.clearBtn.addEventListener('click', () => {
             imageQueue.length = 0;
             dom.resultsTableBody.innerHTML = '';
             dom.noDataMsg.style.display = 'block';
             dom.pdfBtn.disabled = true;
             dom.csvBtn.disabled = true;
             dom.jsonBtn.disabled = true;
             showToast('All items cleared');
        });

        dom.imageUploadInput.addEventListener('change', (event) => {
            if (event.target.files.length > 0) {
                Array.from(event.target.files).forEach(file => {
                    const reader = new FileReader();
                    reader.onload = (e) => handleImageCapture(e.target.result.split(',')[1], e.target.result);
                    reader.readAsDataURL(file);
                });
                event.target.value = null; // Reset so same file can be selected again
            }
        });

        dom.cameraBtn.addEventListener('click', async () => {
            try {
                // facingMode: 'environment' prefers rear camera on mobile
                mediaStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' } 
                });
                dom.cameraVideo.srcObject = mediaStream;
                dom.cameraModal.classList.remove('hidden');
                dom.cameraModal.classList.add('flex');
            } catch (err) { 
                console.error("Error accessing camera: ", err); 
                showToast("Could not access camera. Please check permissions.", "error");
            }
        });

        dom.captureBtn.addEventListener('click', () => {
             if (!dom.cameraVideo.srcObject) return;
             
             const context = dom.cameraCanvas.getContext('2d');
             dom.cameraCanvas.width = dom.cameraVideo.videoWidth;
             dom.cameraCanvas.height = dom.cameraVideo.videoHeight;
             
             // Draw image directly (no mirroring for rear camera)
             context.drawImage(dom.cameraVideo, 0, 0, dom.cameraCanvas.width, dom.cameraCanvas.height);
             
             // Flash effect
             dom.flashOverlay.classList.add('flash');
             setTimeout(() => dom.flashOverlay.classList.remove('flash'), 300);
             
             const dataUrl = dom.cameraCanvas.toDataURL('image/jpeg');
             handleImageCapture(dataUrl.split(',')[1], dataUrl);
             closeCamera();
        });
        
        dom.closeCameraBtn.addEventListener('click', closeCamera);
        dom.pdfBtn.addEventListener('click', generatePdf);
        dom.csvBtn.addEventListener('click', generateCSV);
        // Changed listener from generateJSON to openJsonSettings
        dom.jsonBtn.addEventListener('click', openJsonSettings);
        
        // Modal Event Listeners
        dom.closeJsonBtn.addEventListener('click', closeJsonModal);
        dom.downloadJsonFinalBtn.addEventListener('click', downloadJSON);
        
        // Delegation for retry buttons
        dom.resultsTableBody.addEventListener('click', (event) => {
            if (event.target.classList.contains('retry-btn')) {
                const button = event.target;
                const row = button.closest('tr');
                if (row) {
                    button.disabled = true;
                    button.textContent = 'Retrying...';
                    retryImageProcessing(row.id);
                }
            }
        });
    </script>
</body>
</html>
