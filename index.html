<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Albaik Inventory App (Offline)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="manifest" href="data:application/manifest+json;base64,ewogICJuYW1lIjogIkFsYmFpayBJbnZlbnRvcnkgT2ZmbGluZSIsCiAgInNob3J0X25hbWUiOiAiQWxiYWlrSW52IiwKICAic3RhcnRfdXJsIjogIi4iLAogICJkaXNwbGF5IjogInN0YW5kYWxvbmUiCiB9">
    
    <meta name="theme-color" content="#dc2727">
    
    <!-- PDF Libraries - Fixed Loading Order and Shim -->
    <script src="https://unpkg.com/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script>
        // CRITICAL FIX: Map the UMD build to the global variable autotable expects
        window.jsPDF = window.jspdf.jsPDF;
    </script>
    <script src="https://unpkg.com/jspdf-autotable@3.5.23/dist/jspdf.plugin.autotable.js"></script>
    
    <!-- Excel Library -->
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>

    <style>
        body { background-color: #f8fafc; }
        /* Background Logo Watermark */
        #root::before {
            content: "";
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-image: url('https://cdn.brandfetch.io/idwmB-wz5R/w/800/h/899/theme/dark/symbol.png?c=1bxid64Mup7aczewSAYMX&t=1745978664233');
            background-repeat: no-repeat;
            background-position: center;
            background-size: 50%;
            opacity: 0.05;
            z-index: -1;
        }
    </style>
</head>
<body class="bg-slate-50">
    <div id="root"></div>

    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="text/babel" data-presets="env,react">
        const { useState, useEffect, useCallback, useMemo, useRef } = React;

        // --- IndexedDB Helper ---
        const db = {
            DB_NAME: 'AlbaikInventoryDB',
            STORE_NAME: 'products',
            db: null,
            init() {
                return new Promise((resolve, reject) => {
                    if (this.db) return resolve(this.db);
                    const request = indexedDB.open(this.DB_NAME, 1);
                    request.onupgradeneeded = event => {
                        const db = event.target.result;
                        if (!db.objectStoreNames.contains(this.STORE_NAME)) {
                            db.createObjectStore(this.STORE_NAME, { keyPath: 'id' });
                        }
                    };
                    request.onsuccess = event => {
                        this.db = event.target.result;
                        resolve(this.db);
                    };
                    request.onerror = event => reject('Error opening database');
                });
            },
            addProduct(product) {
                return new Promise((resolve, reject) => {
                    const newProduct = { ...product, id: `local-${Date.now()}-${Math.random()}` };
                    const transaction = this.db.transaction([this.STORE_NAME], 'readwrite');
                    const store = transaction.objectStore(this.STORE_NAME);
                    const request = store.add(newProduct);
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject('Error adding product');
                });
            },
            updateProduct(product) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([this.STORE_NAME], 'readwrite');
                    const store = transaction.objectStore(this.STORE_NAME);
                    const request = store.put(product);
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject('Error updating product');
                });
            },
            getAllProducts() {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([this.STORE_NAME], 'readonly');
                    const store = transaction.objectStore(this.STORE_NAME);
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject('Error getting products');
                });
            },
            deleteProduct(id) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([this.STORE_NAME], 'readwrite');
                    const store = transaction.objectStore(this.STORE_NAME);
                    const request = store.delete(id);
                    request.onsuccess = () => resolve();
                    request.onerror = () => reject('Error deleting product');
                });
            },
            clearAllProducts() {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([this.STORE_NAME], 'readwrite');
                    const store = transaction.objectStore(this.STORE_NAME);
                    const request = store.clear();
                    request.onsuccess = () => resolve();
                    request.onerror = () => reject('Error clearing products');
                });
            }
        };

        // --- Data & Constants ---
        // Using the URL directly instead of Base64 to avoid corruption issues
        const ALBAIK_LOGO_URL = 'https://cdn.brandfetch.io/idwmB-wz5R/w/800/h/899/theme/dark/symbol.png?c=1bxid64Mup7aczewSAYMX&t=1745978664233';

        const productCategories = ['Sauces', 'Drinks', 'Juices', 'Frozen', 'Chiller'];
        
        const frozenSubCategories = {
            'CHICKEN ITEMS': ['Nuggets Regular', 'Nuggets Spicy', 'Nugget Super Regu..', 'Nuggets Super Spicy', 'Burger Regular', 'Burger Spicy', 'Shawarma Regular', 'Shawarma Spicy', 'Chicken Finger', 'Big Baik Regular', 'Big Baik Spicy', 'Saj Regular', 'Saj Spicy', 'Chest Regular', 'Chest Spicy', 'Drumstick', 'Thigh'],
            'FISH ITEMS': ['Fish Nuggets Regular', 'Fish Nuggets Spicy', 'Fish Super Regular', 'Fish Super Spicy', 'Fish Burger', 'Value Regular', 'Value TL', 'Value Spicy', 'Jambo', 'Shrimp Sand..Regu', 'Shrimp Sand..Spicy'],
            'FALAFEL': ['FL Nuggets Regular', 'FL Nuggets Spicy', 'FL Super Regular', 'Falafel Super Spicy'],
            'SIDE': ['Hommus', 'Egg', 'Corn Cup', 'Corn Stick', 'Chips', 'Butter']
        };

        const saucesSubCategories = {
            'Small Sauces': ["Garlic Small", "Nugget Small", "Cocktail Small", "Tahina Small", "Tartar Small"],
            'Big Sauces': ["Garlic Large", "Nugget Large", "Cocktail Large", "TAHINA Large", "Tartar Large"],
            'Super Sauces': ["Garlic Super", "Burger Super Regular", "Burger Super Spicy", "Tahina Super", "Fish Super", "Tartar Super"],
            'Pickels': ["Pickle Regular", "Pickle Spicy", "Sweet Pickle", "Diced Pickle"]
        };

        const productsByCategory = {
            'Sauces': ["Garlic Small", "Garlic Large", "Nugget Small", "Nugget Large", "Cocktail Small", "Cocktail Large", "Tahina Small", "TAHINA Large", "Garlic Super", "Burger Super Regular", "Burger Super Spicy", "Tahina Super", "Fish Super", "Pickle Regular", "Pickle Spicy", "Sweet Pickle", "Diced Pickle", "Tartar Small", "Tartar Large", "Tartar Super", "Other"],
            'Drinks': ['Pepsi', 'Mirinda Citrus', 'Mirinda Orange', '7 Up', 'Shani', 'Pepsi Diet', '7 Up Diet', 'Lipton Peach', 'Lipton Lemon', 'Water', 'Other'],
            'Juices': ['Mango', 'Apple', 'Orange', 'Mix Fruits', 'Large Mango', 'Large Apple', 'Large Orange', 'Large Mix Fruits', 'Other'],
            'Frozen': [...frozenSubCategories['CHICKEN ITEMS'], ...frozenSubCategories['FISH ITEMS'], ...frozenSubCategories['FALAFEL'], ...frozenSubCategories['SIDE'], 'Other'],
            'Chiller': ['Yogurt', 'Cheese', 'Milk', 'Other']
        };
        
        const allProductNames = Object.values(productsByCategory).flat();
        
        const productDateRules = new Map([
            ["Garlic Small", { expireDays: 45, albaikDays: 34 }], ["Garlic Large", { expireDays: 45, albaikDays: 34 }], ["Nugget Small", { expireDays: 45, albaikDays: 34 }], ["Nugget Large", { expireDays: 45, albaikDays: 34 }], ["Cocktail Small", { expireDays: 45, albaikDays: 34 }], ["Cocktail Large", { expireDays: 45, albaikDays: 34 }], ["Tahina Small", { expireDays: 45, albaikDays: 34 }], ["TAHINA Large", { expireDays: 45, albaikDays: 34 }],
            ["Garlic Super", { expireDays: 45, albaikDays: 39 }], ["Burger Super Regular", { expireDays: 45, albaikDays: 39 }], ["Burger Super Spicy", { expireDays: 45, albaikDays: 39 }], ["Tahina Super", { expireDays: 45, albaikDays: 39 }], ["Fish Super", { expireDays: 45, albaikDays: 39 }],
            ["Pickle Regular", { expireDays: 60, albaikDays: 44 }], ["Pickle Spicy", { expireDays: 60, albaikDays: 44 }], ["Sweet Pickle", { expireDays: 60, albaikDays: 44 }], ["Diced Pickle", { expireDays: 60, albaikDays: 44 }],
            ["Tartar Small", { expireDays: 30, albaikDays: 20 }], ["Tartar Large", { expireDays: 30, albaikDays: 20 }], ["Tartar Super", { expireDays: 30, albaikDays: 24 }],
        ]);
        
        const juiceDateRules = new Map([
            ['Mango', { subtractDays: 5 }], ['Large Mango', { subtractDays: 5 }], ['Mix Fruits', { subtractDays: 5 }], ['Large Mix Fruits', { subtractDays: 5 }],
            ['Apple', { subtractDays: 9 }], ['Large Apple', { subtractDays: 9 }], ['Orange', { subtractDays: 9 }], ['Large Orange', { subtractDays: 9 }],
        ]);
        
        // --- Utilities ---
        const addDaysAndFormat = (dateStr, days) => { const date = new Date(dateStr); date.setDate(date.getDate() + days); return date.toISOString().split('T')[0]; };
        const subtractDaysAndFormat = (dateStr, days) => { const date = new Date(dateStr); date.setDate(date.getDate() - days); return date.toISOString().split('T')[0]; };
        const calculateRemainingDays = (dateStr) => { if (!dateStr) return null; const today = new Date(); const expiryDate = new Date(dateStr); today.setHours(0, 0, 0, 0); expiryDate.setHours(0, 0, 0, 0); const diffTime = expiryDate.getTime() - today.getTime(); return Math.ceil(diffTime / (1000 * 60 * 60 * 24)); };
        
        const formatDate = (dateStr) => { if (!dateStr) return 'N/A'; try { const date = new Date(dateStr); const day = String(date.getDate()).padStart(2, '0'); const month = String(date.getMonth() + 1).padStart(2, '0'); const year = date.getFullYear(); return `${day}/${month}/${year}`; } catch (e) { return 'Invalid Date'; } };
        
        const parseDDMMYYYY = (str) => {
            if (!str) return null;
            const parts = str.match(/^(\d{1,2})[\/.](\d{1,2})[\/.](\d{2,4})$/);
            if (parts) {
                const day = parts[1].padStart(2, '0');
                const month = parts[2].padStart(2, '0');
                let year = parts[3];
                if(year.length === 2) year = '20' + year;
                if (parseInt(month) > 12 || parseInt(day) > 31) return null;
                return `${year}-${month}-${day}`;
            }
            return null;
        };

        const formatDateInput = (value) => {
            const digits = value.replace(/\D/g, '');
            if (digits.length <= 2) return digits;
            if (digits.length <= 4) return `${digits.slice(0, 2)}.${digits.slice(2)}`;
            return `${digits.slice(0, 2)}.${digits.slice(2, 4)}.${digits.slice(4, 8)}`;
        };

        // Helper to load image for PDF
        const loadImage = (url) => {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.crossOrigin = "Anonymous"; // Attempt to handle CORS
                img.onload = () => resolve(img);
                img.onerror = (e) => reject(e);
                img.src = url;
            });
        };

        // --- Icons ---
        const PlusIcon = ({ className }) => (<svg className={className} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M12 4v16m8-8H4" /></svg>);
        const TrashIcon = ({ className }) => (<svg className={className} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>);
        const ShareIcon = ({ className }) => (<svg className={className} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M8.684 13.342C8.886 12.938 9 12.482 9 12s-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.368a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z" /></svg>);
        const WarningIcon = ({ className }) => (<svg className={className} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>);
        const ClipboardCopyIcon = ({ className }) => (<svg className={className} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>);
        const CheckIcon = ({ className }) => (<svg className={className} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M5 13l4 4L19 7" /></svg>);
        const ExcelIcon = ({ className }) => (<svg className={className} viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M14 2H6C4.89543 2 4 2.89543 4 4V20C4 21.1046 4.89543 22 6 22H18C19.1046 22 20 21.1046 20 20V8L14 2Z" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/><path d="M14 2V8H20" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/><path d="M12 18L15 15L12 12" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/><path d="M9 12L12 15L9 18" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/></svg>);
        const PdfIcon = ({ className }) => (<svg className={className} viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M14 2H6C4.89543 2 4 2.89543 4 4V20C4 21.1046 4.89543 22 6 22H18C19.1046 22 20 21.1046 20 20V8L14 2Z" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/><path d="M14 2V8H20" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/><path d="M9 14V12C9 11.4477 9.44772 11 10 11H12C13.1046 11 14 11.8954 14 13C14 14.1046 13.1046 15 12 15H10" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/><path d="M9 18V14" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/></svg>);
        const WhatsappIcon = ({ className }) => (<svg className={className} viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M16.75 13.96c.25.41.41.86.41 1.36 0 1.9-1.57 3.47-3.47 3.47-1.13 0-2.13-.54-2.76-1.37-.17-.23-.33-.48-.47-.73-.42-.73-.67-1.58-.67-2.5 0-2.81 2.28-5.09 5.09-5.09.92 0 1.77.25 2.5.67.25.14.48.3.73.47.83.63 1.37 1.63 1.37 2.76 0 .5-.16.95-.41 1.36zM12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/></svg>);

        const RemainingDaysDisplay = ({ days }) => { if (days === null) { return <span className="text-slate-500">N/A</span>; } const colorClass = days <= 0 ? 'text-red-600' : days < 8 ? 'text-yellow-600' : 'text-green-600'; const fontWeight = days < 8 ? 'font-bold' : 'font-semibold'; return <span className={`${colorClass} ${fontWeight}`}>{days} Days</span>; };
        
        const ConfirmationModal = ({ isOpen, onClose, onConfirm, title, children }) => { if (!isOpen) return null; return (<div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-4"><div className="bg-white rounded-lg shadow-2xl p-6 md:p-8 w-full max-w-md"><h2 className="text-2xl font-bold text-slate-800 mb-4">{title}</h2><div className="text-slate-600 mb-6">{children}</div><div className="flex justify-end gap-4"><button onClick={onClose} className="px-4 py-2 rounded-md text-slate-700 bg-slate-200 hover:bg-slate-300 transition-colors">Cancel</button><button onClick={onConfirm} className="px-4 py-2 rounded-md text-white bg-red-600 hover:bg-red-700 transition-colors">Confirm</button></div></div></div>); };
        
        const ExtensionRequestModal = ({ isOpen, onClose, expiredProducts }) => { const [copySuccess, setCopySuccess] = useState(false); const textAreaRef = useRef(null); const reportText = useMemo(() => { let report = "ðŸš¨ Urgent: Extension Request ðŸš¨\n\nDear Sir,\n\nSome of our items have already expired. We kindly request an extension for the following products:\n\n"; expiredProducts.forEach(p => { report += `â¸»\n`; report += `ðŸ“¦ Product: ${p.productName}\n`; report += `ðŸ”¢ Batch No: ${p.batchNumber || 'N/A'}\n`; if(p.productionDate) report += `ðŸ› ï¸ Production Date: ${formatDate(p.productionDate)}\n`; report += `ðŸ—“ï¸ Expire Date: ${formatDate(p.expireDate)}\n`; if(p.albaikExpire) report += `â³ Albaik Shelf Life: ${formatDate(p.albaikExpire)}\n`; report += `ðŸ›’ Quantity: ${p.quantityCarton || 0} Ctn, ${p.quantityPiece || 0} Pcs\n\n`; }); return report; }, [expiredProducts]); const handleCopyToClipboard = () => { if (textAreaRef.current) { textAreaRef.current.select(); document.execCommand('copy'); setCopySuccess(true); setTimeout(() => setCopySuccess(false), 2000); } }; const handleNativeShare = async () => { if (navigator.share) { try { await navigator.share({ title: 'Expired Items - Extension Request', text: reportText }); onClose(); } catch (error) { if (error.name !== 'AbortError') handleCopyToClipboard(); } } }; if (!isOpen) return null; return (<div className="fixed inset-0 bg-black bg-opacity-70 z-50 flex justify-center items-center p-4"><div className="bg-white rounded-xl shadow-2xl w-full max-w-2xl flex flex-col h-[90vh]"><h2 className="text-2xl font-bold text-slate-800 p-6 border-b">Extension Request for Expired Items</h2><div className="p-6 flex-grow overflow-y-auto"><textarea ref={textAreaRef} readOnly className="w-full h-full p-3 border rounded-lg bg-slate-50 font-mono text-sm resize-none focus:outline-none" value={reportText}></textarea></div><div className="p-6 border-t flex flex-col sm:flex-row justify-end gap-3"><button onClick={handleCopyToClipboard} className={`flex items-center justify-center gap-2 w-full sm:w-auto px-4 py-2 rounded-lg font-semibold transition-colors ${copySuccess ? 'bg-green-600 text-white' : 'bg-indigo-100 text-indigo-700 hover:bg-indigo-200'}`}>{copySuccess ? <><CheckIcon className="w-5 h-5" /> Copied!</> : <><ClipboardCopyIcon className="w-5 h-5" /> Copy</>}</button>{navigator.share && (<button onClick={handleNativeShare} className="flex items-center justify-center gap-2 w-full sm:w-auto px-4 py-2 bg-green-500 text-white font-semibold rounded-lg hover:bg-green-600"><ShareIcon className="w-5 h-5" /> Share...</button>)}<button onClick={onClose} className="w-full sm:w-auto px-4 py-2 rounded-lg text-slate-700 bg-slate-200 hover:bg-slate-300 font-semibold">Close</button></div></div></div>); };
        
        const ShareDialog = ({ isOpen, onClose, products }) => {
            const [reportType, setReportType] = useState('inventory');
            const [copySuccess, setCopySuccess] = useState(false);
            const textAreaRef = useRef(null);
            // State for loading indicator
            const [isGeneratingPdf, setIsGeneratingPdf] = useState(false);
            
            const [selectedProducts, setSelectedProducts] = useState(() => new Set(allProductNames));
            const [statusFilter, setStatusFilter] = useState('all');
            
            // Header Date: DD/MM/YYYY
            const headerDate = formatDate(new Date().toISOString());
            
            const sortedProducts = useMemo(() => {
                const filtered = products
                    .filter(p => selectedProducts.has(p.productName))
                    .filter(p => {
                        const dateToCheck = p.category === 'Frozen' ? p.expireDate : p.albaikExpire;
                        const remainingDays = calculateRemainingDays(dateToCheck);
                        if (statusFilter === 'active') return remainingDays > 0;
                        if (statusFilter === 'expired') return remainingDays <= 0;
                        if (statusFilter === 'expiring_soon') return remainingDays > 0 && remainingDays <= 3;
                        return true;
                    });
                
                filtered.sort((a, b) => {
                    const nameComp = a.productName.localeCompare(b.productName);
                    if (nameComp !== 0) return nameComp;
                    const dateToCheckA = (a.category === 'Frozen' || a.category === 'Drinks') ? a.expireDate : a.albaikExpire;
                    const dateToCheckB = (b.category === 'Frozen' || b.category === 'Drinks') ? b.expireDate : b.albaikExpire;
                    const remainingA = calculateRemainingDays(dateToCheckA);
                    const remainingB = calculateRemainingDays(dateToCheckB);
                    if (remainingA === null) return 1;
                    if (remainingB === null) return -1;
                    return remainingA - remainingB;
                });
                return filtered;
            }, [products, selectedProducts, statusFilter]);
            
            // --- MODIFIED REPORT GENERATION LOGIC ---
            const inventoryReportText = useMemo(() => {
                // 1. Header with specific emojis
                let report = `ðŸ›KJ04 HUDAITHI MALLðŸ›\nðŸ”AL BAIK RESTAURANT ðŸ”\nðŸŽ²DAILY INVENTORY SUMMARY ðŸŽ²\nðŸ“ðŸ“DATE : ${headerDate} ðŸ“ðŸ“\n\n`;

                // 2. Helper to format date as DD.MM.YY (e.g., 23.10.25)
                const fmtDate = (dateStr) => {
                    if (!dateStr) return 'N/A';
                    try {
                        const d = new Date(dateStr);
                        const day = String(d.getDate()).padStart(2, '0');
                        const month = String(d.getMonth() + 1).padStart(2, '0');
                        const year = String(d.getFullYear()).slice(-2); // Last 2 digits
                        return `${day}.${month}.${year}`;
                    } catch (e) { return 'N/A'; }
                };

                // 3. Helper to determine Emoji based on Name/Category
                const getEmoji = (name, category) => {
                    const n = name.toLowerCase();
                    let baseEmoji = 'ðŸ—'; // Default

                    // Specific Categories
                    if (category === 'Sauces') baseEmoji = 'ðŸ¥«';
                    else if (category === 'Drinks') baseEmoji = 'ðŸ¥¤';
                    else if (category === 'Juices') baseEmoji = 'ðŸ§ƒ';
                    else if (category === 'Chiller') baseEmoji = 'ðŸ§Š';
                    else {
                        // Specific Frozen Items
                        if (n.includes('burger')) baseEmoji = 'ðŸ”';
                        else if (n.includes('shrimp') || n.includes('value')) baseEmoji = 'ðŸ¦';
                        else if (n.includes('fish')) baseEmoji = 'ðŸŸ';
                        
                        // Falafel
                        else if (n.includes('falafel') || n.includes('fl ')) {
                            if (n.includes('super')) baseEmoji = 'ðŸ¥™'; // Sandwich style
                            else baseEmoji = 'ðŸ§†'; // Nuggets style
                        }
                        
                        // Sides
                        else if (n.includes('corn')) baseEmoji = 'ðŸŒ½';
                        else if (n.includes('chips')) baseEmoji = 'ðŸŸ';
                        else if (n.includes('egg')) baseEmoji = 'ðŸ¥š';
                        else if (n.includes('butter')) baseEmoji = 'ðŸ§ˆ';
                        else if (n.includes('hommus')) baseEmoji = 'ðŸ¥£';

                        // Wraps/Sandwiches (Super/Saj)
                        else if (n.includes('super') || n.includes('saj')) baseEmoji = 'ðŸŒ¯';
                    }
                    
                    // Add Spicy Indicator
                    if (n.includes('spicy')) {
                        return baseEmoji + 'ðŸŒ¶ï¸';
                    }

                    return baseEmoji;
                };

                // 4. Group products by Name first to stack batches
                const groupProductsByName = (items) => {
                    const grouped = {};
                    items.forEach(item => {
                        if (!grouped[item.productName]) grouped[item.productName] = [];
                        grouped[item.productName].push(item);
                    });
                    return grouped;
                };

                // 5. Generate Section Function
                const generateSection = (title, emoji, items) => {
                    if (items.length === 0) return '';
                    let sectionText = `${emoji.repeat(26)}\n${title}\n\nâ¸»\n\n`;
                    
                    const grouped = groupProductsByName(items);
                    
                    Object.keys(grouped).forEach(name => {
                        const batches = grouped[name];
                        const itemEmoji = getEmoji(name, batches[0].category);
                        
                        // Item Header: ðŸ—CHICKEN NUGGETS REGðŸ—
                        sectionText += `${itemEmoji}${name.toUpperCase()}${itemEmoji}\n\n`;
                        
                        // Batches
                        batches.forEach(batch => {
                            // Production Date (if exists)
                            if (batch.productionDate) sectionText += `P.${fmtDate(batch.productionDate)}\n`;
                            // Expire Date
                            sectionText += `E.${fmtDate(batch.expireDate)}\n`;
                            // Quantity
                            const qty = batch.quantityPiece > 0 
                                ? `${batch.quantityCarton} crt, ${batch.quantityPiece} pcs`
                                : `${batch.quantityCarton} crt`;
                            sectionText += `Qty.${qty}\n\n`;
                        });
                    });
                    
                    return sectionText;
                };

                // --- PROCESS FROZEN ITEMS (Specific Order) ---
                const frozenProducts = sortedProducts.filter(p => p.category === 'Frozen');
                
                // Defined subcategories map order
                const frozenOrder = [
                    { key: 'CHICKEN ITEMS', title: 'CHICKEN ITEMS', emoji: 'ðŸ—' },
                    { key: 'FISH ITEMS', title: 'FISH ITEMS ðŸŸðŸŸðŸŸ', emoji: 'ðŸŸ' },
                    { key: 'FALAFEL', title: 'FALAFEL ITEMS ðŸ§†ðŸ§†', emoji: 'ðŸ§†' },
                    { key: 'SIDE', title: 'SIDES ITEMS â­â­â­â­', emoji: 'â­' }
                ];

                frozenOrder.forEach(section => {
                    const namesInSub = frozenSubCategories[section.key] || [];
                    const items = frozenProducts.filter(p => namesInSub.includes(p.productName));
                    if (items.length > 0) {
                        report += generateSection(section.title, section.emoji, items);
                        report += `â¸»\n\n`;
                    }
                });

                // Catch-all for Frozen items not in the sub-lists (e.g. "Other")
                const allDefinedFrozenNames = Object.values(frozenSubCategories).flat();
                const otherFrozen = frozenProducts.filter(p => !allDefinedFrozenNames.includes(p.productName));
                if (otherFrozen.length > 0) {
                     report += generateSection('OTHER FROZEN', 'ðŸ§Š', otherFrozen);
                     report += `â¸»\n\n`;
                }

                // --- PROCESS OTHER CATEGORIES (Sauces, Drinks, etc.) ---
                const remainingCats = ['Sauces', 'Drinks', 'Juices', 'Chiller'];
                remainingCats.forEach(cat => {
                    const items = sortedProducts.filter(p => p.category === cat);
                    if (items.length > 0) {
                        const catEmoji = getEmoji('', cat); 
                        report += generateSection(`${cat.toUpperCase()} ITEMS`, catEmoji, items);
                        report += `â¸»\n\n`;
                    }
                });
                
                report += `ðŸ‘†Thanks ðŸ‘†`;

                return report;
            }, [sortedProducts, headerDate]);
            // -------------------------------------

            const storeBalanceData = useMemo(() => {
                const inventoryTotals = products.reduce((acc, p) => {
                    if (!acc[p.productName]) { acc[p.productName] = { cartons: 0, pieces: 0, category: p.category }; }
                    acc[p.productName].cartons += p.quantityCarton || 0;
                    acc[p.productName].pieces += p.quantityPiece || 0;
                    return acc;
                }, {});
                const completeList = [];
                Object.entries(productsByCategory).forEach(([category, productNames]) => {
                    productNames.forEach(name => {
                        if (name === 'Other') return;
                        const totals = inventoryTotals[name] || { cartons: 0, pieces: 0 };
                        completeList.push({ name, category, cartons: totals.cartons, pieces: totals.pieces, isAvailable: totals.cartons > 0 || totals.pieces > 0, });
                    });
                });
                return completeList.sort((a,b) => a.name.localeCompare(b.name));
            }, [products]);
            
            const storeBalanceReportText = useMemo(() => {
                let report = `ðŸª Store Balance Report â€“ ${headerDate}\n\n`;
                storeBalanceData.forEach(item => {
                    report += `â¸»\n`;
                    report += `ðŸ“¦ Product: ${item.name} (${item.category})\n`;
                    if (item.isAvailable) { report += `ðŸ›’ Total: ${item.cartons} Ctn, ${item.pieces} Pcs\n\n`; } else { report += `ðŸ›’ Total: Out of Stock\n\n`; }
                });
                return report.trim();
            }, [storeBalanceData, headerDate]);
            
            const currentReportText = reportType === 'inventory' ? inventoryReportText : storeBalanceReportText;
            
            const handleCopyToClipboard = () => { if (textAreaRef.current) { textAreaRef.current.select(); document.execCommand('copy'); setCopySuccess(true); setTimeout(() => setCopySuccess(false), 2000); } };
            const handleWhatsAppShare = () => { const encodedText = encodeURIComponent(currentReportText); window.open(`https://wa.me/?text=${encodedText}`, '_blank'); };
            
            const handleExportPdf = async () => {
                setIsGeneratingPdf(true);
                try {
                    // Correctly access jsPDF from window
                    const jsPDF = window.jsPDF || window.jspdf.jsPDF;
                    if (!jsPDF) {
                        alert("PDF library not loaded correctly. Please refresh the page.");
                        setIsGeneratingPdf(false);
                        return;
                    }

                    const doc = new jsPDF({ orientation: reportType === 'inventory' ? 'landscape' : 'portrait' });
                    const pageWidth = doc.internal.pageSize.getWidth();
                    
                    // Attempt to load the logo
                    try {
                        const img = await loadImage(ALBAIK_LOGO_URL);
                        const logoWidth = 40; 
                        // Maintain aspect ratio if possible, or use fixed
                        const logoHeight = 40;
                        const logoX = (pageWidth - logoWidth) / 2;
                        doc.addImage(img, 'PNG', logoX, 10, logoWidth, logoHeight);
                    } catch (imgErr) {
                        console.warn("Logo load failed, using fallback:", imgErr);
                        // Fallback: Text Logo
                        doc.setFontSize(10);
                        doc.setTextColor(220, 39, 39); // Albaik Red
                        doc.text("(Albaik Logo Unavailable)", pageWidth/2, 25, { align: 'center' });
                        doc.setTextColor(0, 0, 0); // Reset color
                    }
                    
                    doc.setFontSize(18); doc.setFont(undefined, 'bold');
                    doc.text("KJ04 Hudaithi Mall", pageWidth/2, 60, { align: 'center' });
                    doc.setFontSize(12); doc.setFont(undefined, 'normal');
                    doc.text(`Report Date: ${headerDate}`, pageWidth/2, 68, { align: 'center' });
                    
                    let startY = 80;
                    
                    if (typeof doc.autoTable !== 'function') {
                        throw new Error("AutoTable plugin not initialized");
                    }

                    if (reportType === 'inventory') {
                        const tableColumn = ["Product", "Batch", "Prod. Date", "Exp. Date", "Qty (Ctn)", "Qty (Pcs)", "Days Left"];
                        const tableRows = sortedProducts.map(p => [
                            p.productName, p.batchNumber || '-', formatDate(p.productionDate), formatDate(p.expireDate), 
                            p.quantityCarton, p.quantityPiece, calculateRemainingDays(p.category === 'Frozen' ? p.expireDate : p.albaikExpire)
                        ]);
                        
                        doc.autoTable({
                            head: [tableColumn], body: tableRows, startY,
                            headStyles: { fillColor: [220, 39, 39] },
                            styles: { fontSize: 10 }
                        });
                    } else {
                        const tableColumn = ["Product Name", "Category", "Total Cartons", "Status"];
                        const tableRows = storeBalanceData.map(item => [item.name, item.category, item.cartons, item.isAvailable ? 'In Stock' : 'Out of Stock']);
                        doc.autoTable({
                            head: [tableColumn], body: tableRows, startY,
                            headStyles: { fillColor: [220, 39, 39] }
                        });
                    }
                    doc.save(`albaik_${reportType}_report.pdf`);
                } catch (error) { 
                    console.error("PDF Export Error", error); 
                    alert(`Failed to generate PDF: ${error.message}`); 
                } finally {
                    setIsGeneratingPdf(false);
                }
            };

            const handleExportExcel = () => {
                let wb = XLSX.utils.book_new();
                let fileName;
                if (reportType === 'inventory') {
                    const data = sortedProducts.map(p => ({ 'Category': p.category, 'Product Name': p.productName, 'Batch No.': p.batchNumber || 'N/A', 'Production Date': formatDate(p.productionDate), 'Expire Date': formatDate(p.expireDate), 'Qty (Ctn)': p.quantityCarton || 0, 'Qty (Pcs)': p.quantityPiece || 0, 'Days Left': calculateRemainingDays(p.category === 'Frozen' ? p.expireDate : p.albaikExpire) ?? 'N/A' }));
                    const ws = XLSX.utils.json_to_sheet(data);
                    XLSX.utils.book_append_sheet(wb, ws, "Inventory");
                    fileName = "albaik_inventory.xlsx";
                } else {
                    const data = storeBalanceData.map(item => ({ 'Product Name': item.name, 'Category': item.category, 'Total Cartons': item.cartons, 'Total Pieces': item.pieces, 'Status': item.isAvailable ? 'In Stock' : 'Out of Stock' }));
                    const ws = XLSX.utils.json_to_sheet(data);
                    XLSX.utils.book_append_sheet(wb, ws, "Balance");
                    fileName = "albaik_balance.xlsx";
                }
                XLSX.writeFile(wb, fileName);
            };
            
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black bg-opacity-70 z-50 flex justify-center items-center p-4">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-7xl flex flex-col h-[90vh]">
                        <div className="p-4 border-b">
                            <h2 className="text-2xl font-bold text-slate-800 text-center">Share & Export</h2>
                            <p className="text-center text-sm text-slate-500">{headerDate}</p>
                        </div>
                        <div className="p-4 flex justify-center bg-slate-100 rounded-lg mx-4 mt-4 gap-2">
                             <button onClick={() => setReportType('inventory')} className={`px-4 py-2 text-sm font-semibold rounded-md w-1/2 ${reportType === 'inventory' ? 'bg-white shadow text-red-600' : 'text-slate-600'}`}>Inventory Report</button>
                             <button onClick={() => setReportType('balance')} className={`px-4 py-2 text-sm font-semibold rounded-md w-1/2 ${reportType === 'balance' ? 'bg-white shadow text-red-600' : 'text-slate-600'}`}>Store Balance</button>
                        </div>
                        <div className="flex flex-col md:flex-row flex-grow min-h-0 p-4 gap-4">
                            <div className="w-full h-full flex flex-col">
                                <h3 className="font-semibold mb-2">Preview</h3>
                                <textarea ref={textAreaRef} readOnly className="w-full flex-grow p-3 border rounded-lg bg-slate-50 font-mono text-sm resize-none focus:outline-none" value={currentReportText}></textarea>
                            </div>
                        </div>
                        <div className="p-4 border-t flex justify-between items-center bg-slate-50">
                             <div className="flex gap-2">
                                <button onClick={handleCopyToClipboard} className="h-10 w-10 flex items-center justify-center rounded-full bg-slate-200 text-slate-700 hover:bg-slate-300">{copySuccess ? <CheckIcon className="w-5 h-5 text-green-600" /> : <ClipboardCopyIcon className="w-5 h-5" />}</button>
                                <button onClick={handleWhatsAppShare} className="h-10 w-10 flex items-center justify-center rounded-full bg-green-100 text-green-600 hover:bg-green-200"><WhatsappIcon className="w-6 h-6" /></button>
                                <button onClick={handleExportPdf} disabled={isGeneratingPdf} className={`h-10 w-10 flex items-center justify-center rounded-full text-red-600 hover:bg-red-200 ${isGeneratingPdf ? 'bg-red-50 opacity-50 cursor-not-allowed' : 'bg-red-100'}`}>{isGeneratingPdf ? <div className="w-5 h-5 border-2 border-red-600 border-t-transparent rounded-full animate-spin"></div> : <PdfIcon className="w-5 h-5" />}</button>
                                <button onClick={handleExportExcel} className="h-10 w-10 flex items-center justify-center rounded-full bg-green-100 text-green-800 hover:bg-green-200"><ExcelIcon className="w-5 h-5" /></button>
                            </div>
                            <button onClick={onClose} className="px-4 py-2 rounded-lg text-slate-700 bg-slate-200 hover:bg-slate-300 font-semibold">Close</button>
                        </div>
                    </div>
                </div>
            );
        };

        const SearchableSelect = ({ options, value, onChange, placeholder, disabled }) => {
            const [isOpen, setIsOpen] = useState(false);
            const [searchTerm, setSearchTerm] = useState('');
            const wrapperRef = useRef(null);
            const filteredOptions = useMemo(() => options.filter(option => option.label.toLowerCase().includes(searchTerm.toLowerCase())), [options, searchTerm]);
            const selectedOptionLabel = options.find(opt => opt.value === value)?.label || '';
            useEffect(() => { const handleClickOutside = (event) => { if (wrapperRef.current && !wrapperRef.current.contains(event.target)) { setIsOpen(false); } }; document.addEventListener("mousedown", handleClickOutside); return () => { document.removeEventListener("mousedown", handleClickOutside); }; }, []);
            const handleSelect = (optionValue) => { if(disabled) return; onChange(optionValue); setIsOpen(false); setSearchTerm(''); };
            return (
                <div className="relative w-full" ref={wrapperRef}>
                    <div className={`w-full border border-slate-300 rounded-lg flex items-center justify-between ${disabled ? 'bg-slate-100 cursor-not-allowed' : 'bg-white focus-within:ring-2 focus-within:ring-red-500'}`}>
                        <input type="text" placeholder={!value ? placeholder : ''} className={`w-full px-4 py-2 bg-transparent outline-none cursor-pointer ${disabled ? 'placeholder-slate-400 cursor-not-allowed' : ''}`} value={isOpen ? searchTerm : selectedOptionLabel} onFocus={() => { if(disabled) return; setIsOpen(true); setSearchTerm(''); }} onChange={(e) => setSearchTerm(e.target.value)} disabled={disabled} />
                        <svg onClick={() => !disabled && setIsOpen(!isOpen)} className="w-5 h-5 text-slate-400 mr-2 cursor-pointer" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 9l-7 7-7-7"></path></svg>
                    </div>
                    {isOpen && !disabled && (<ul className="absolute z-20 w-full mt-1 bg-white border border-slate-300 rounded-lg shadow-lg max-h-60 overflow-y-auto">{filteredOptions.length > 0 ? filteredOptions.map(option => (<li key={option.value} className={`px-4 py-2 cursor-pointer hover:bg-red-100 ${value === option.value ? 'bg-red-100 font-semibold' : ''}`} onClick={() => handleSelect(option.value)}>{option.label}</li>)) : <li className="px-4 py-2 text-slate-500">No results found</li>}</ul>)}
                </div>
            );
        };

        const ProductForm = ({ onAddProduct, isAdding }) => {
            const [productName, setProductName] = useState('');
            const [otherProductName, setOtherProductName] = useState('');
            const [category, setCategory] = useState('');
            const [productionDate, setProductionDate] = useState('');
            const [expireDate, setExpireDate] = useState('');
            const [albaikExpire, setAlbaikExpire] = useState('');
            const [quantityCarton, setQuantityCarton] = useState('');
            const [quantityPiece, setQuantityPiece] = useState('');
            const [batchNumber, setBatchNumber] = useState('');
            const [remainingDays, setRemainingDays] = useState(null);
            const [error, setError] = useState('');
            const [displayProdDate, setDisplayProdDate] = useState('');
            const [displayExpireDate, setDisplayExpireDate] = useState('');

            const isFrozen = category === 'Frozen';
            const isJuice = category === 'Juices';
            const isDrinks = category === 'Drinks';
            const isManualDateCategory = isFrozen || isDrinks;

            useEffect(() => { setProductionDate(''); setExpireDate(''); setAlbaikExpire(''); setDisplayProdDate(''); setDisplayExpireDate(''); }, [category]);
            useEffect(() => {
                if (isFrozen) { setAlbaikExpire(''); return; }
                if (isDrinks) { if (productionDate) { setAlbaikExpire(addDaysAndFormat(productionDate, 34)); } else { setAlbaikExpire(''); } return; }
                if (isJuice) { const juiceRules = juiceDateRules.get(productName); if (juiceRules && expireDate) { setAlbaikExpire(subtractDaysAndFormat(expireDate, juiceRules.subtractDays)); } else { setAlbaikExpire(''); } return; }
                const rules = productDateRules.get(productName);
                if (rules && productionDate) { setExpireDate(addDaysAndFormat(productionDate, rules.expireDays)); setAlbaikExpire(addDaysAndFormat(productionDate, rules.albaikDays)); } else { setExpireDate(''); setAlbaikExpire(''); }
            }, [productName, productionDate, expireDate, category, isFrozen, isJuice, isDrinks]);
            
            useEffect(() => { const dateToCheck = isFrozen ? expireDate : albaikExpire; setRemainingDays(dateToCheck ? calculateRemainingDays(dateToCheck) : null); }, [albaikExpire, expireDate, category, isFrozen, isDrinks]);
            const handleCategoryChange = (newCategory) => { setCategory(newCategory); setProductName(''); setOtherProductName(''); };
            const handleSubmit = (e) => {
                e.preventDefault(); setError('');
                const finalProductName = productName === 'Other' ? otherProductName : productName;
                const finalAlbaikExpire = isFrozen ? '' : albaikExpire;
                const finalProductionDate = isJuice ? '' : productionDate;
                const cartonQty = Number(quantityCarton) || 0;
                const pieceQty = Number(quantityPiece) || 0;
                if (!finalProductName || !category) { setError('Please fill out Category and Product Name.'); return; }
                if (!expireDate) { setError('Expire Date is required for all products.'); return; }
                if (!isJuice && !isFrozen && !productionDate) { setError('Production date is required for this category.'); return; }
                if (!isFrozen && !finalAlbaikExpire) { setError('Albaik Shelf Life date is required for this category.'); return; }
                if (cartonQty <= 0 && pieceQty <= 0) { setError('Please provide a quantity for either cartons or pieces.'); return; }
                if (remainingDays !== null && remainingDays <= 0 && !batchNumber) { setError('Batch number is required for expired items.'); return; }
                onAddProduct({ productName: finalProductName, category, productionDate: finalProductionDate, expireDate, albaikExpire: finalAlbaikExpire, batchNumber, quantityCarton: cartonQty > 0 ? cartonQty : 0, quantityPiece: pieceQty > 0 ? pieceQty : 0, });
                setProductName(''); setOtherProductName(''); setProductionDate(''); setExpireDate(''); setAlbaikExpire(''); setDisplayProdDate(''); setDisplayExpireDate(''); setQuantityCarton(''); setQuantityPiece(''); setRemainingDays(null); setBatchNumber('');
            };

            return (
                <div className="bg-white p-6 md:p-8 rounded-xl shadow-md border border-slate-200">
                    <h2 className="text-2xl font-bold text-slate-700 mb-6">Add New Product</h2>
                    <form onSubmit={handleSubmit} className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        {error && <p className="text-red-500 text-sm lg:col-span-3">{error}</p>}
                        <div><label className="block text-sm font-medium text-slate-600 mb-1">Category</label><SearchableSelect options={productCategories.map(c => ({value: c, label: c}))} value={category} onChange={handleCategoryChange} placeholder="Select a category" /></div>
                        <div className="lg:col-span-2"><label className="block text-sm font-medium text-slate-600 mb-1">Product Name</label><div className="flex gap-2"><SearchableSelect options={(productsByCategory[category] || []).map(p => ({value: p, label: p}))} value={productName} onChange={(val) => setProductName(val)} placeholder="Select a product" disabled={!category} />{productName === 'Other' && (<input type="text" value={otherProductName} onChange={e => setOtherProductName(e.target.value)} placeholder="Enter custom name" className="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-red-500" required />)}</div></div>
                        {!isJuice && (<div><label className="block text-sm font-medium text-slate-600 mb-1">Production Date</label>{isManualDateCategory ? (<input type="text" value={displayProdDate} onChange={(e) => { const formatted = formatDateInput(e.target.value); setDisplayProdDate(formatted); const parsed = parseDDMMYYYY(formatted); if (parsed) setProductionDate(parsed); }} placeholder="DD.MM.YYYY" className="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-red-500" />) : (<input type="date" value={productionDate} onChange={(e) => setProductionDate(e.target.value)} className="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-red-500" required />)}</div>)}
                        <div><label className="block text-sm font-medium text-slate-600 mb-1">Expire Date</label>{isManualDateCategory ? (<input type="text" value={displayExpireDate} onChange={(e) => { const formatted = formatDateInput(e.target.value); setDisplayExpireDate(formatted); const parsed = parseDDMMYYYY(formatted); if (parsed) setExpireDate(parsed); }} placeholder="DD.MM.YYYY" className="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-red-500" required />) : (<input type="date" value={expireDate} onChange={(e) => setExpireDate(e.target.value)} className="w-full px-4 py-2 border border-slate-300 rounded-lg read-only:bg-slate-100" required readOnly={!isJuice && productDateRules.has(productName)} />)}</div>
                        {!isFrozen && (<div><label className="block text-sm font-medium text-slate-600 mb-1">Albaik Shelf Life</label><input type="date" value={albaikExpire} className="w-full px-4 py-2 border border-slate-300 rounded-lg read-only:bg-slate-100" readOnly /></div>)}
                        {remainingDays !== null && remainingDays <= 0 && (<div><label className="block text-sm font-medium text-slate-600 mb-1">Batch No.</label><input type="text" value={batchNumber} onChange={e => setBatchNumber(e.target.value)} className="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-red-500" placeholder="e.g. 12345" required /></div>)}
                        <div><label className="block text-sm font-medium text-slate-600 mb-1">Quantity (Cartons)</label><input type="number" value={quantityCarton} onChange={(e) => setQuantityCarton(e.target.value)} min="0" className="w-full px-4 py-2 border border-slate-300 rounded-lg" placeholder="e.g. 10" /></div>
                        <div><label className="block text-sm font-medium text-slate-600 mb-1">Quantity (Pieces)</label><input type="number" value={quantityPiece} onChange={(e) => setQuantityPiece(e.target.value)} min="0" className="w-full px-4 py-2 border border-slate-300 rounded-lg" placeholder="e.g. 50" /></div>
                        <div><label className="block text-sm font-medium text-slate-600 mb-1">Remaining Days</label><div className="w-full h-[42px] px-4 py-2 border border-slate-200 rounded-lg bg-slate-100 flex items-center justify-center"><RemainingDaysDisplay days={remainingDays} /></div></div>
                        <div className="lg:col-span-3 flex items-end"><button type="submit" disabled={isAdding} className="w-full flex items-center justify-center gap-2 px-6 py-3 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700 disabled:bg-red-300 transition-colors">{isAdding ? 'Adding...' : <><PlusIcon className="w-5 h-5" /> Add Product</>}</button></div>
                    </form>
                </div>
            );
        };

        const ProductList = ({ products, onDeleteProduct, onClearAll, isClearing }) => {
            const [isConfirmModalOpen, setIsConfirmModalOpen] = useState(false);
            const [isShareDialogOpen, setIsShareDialogOpen] = useState(false);
            const [isExtensionModalOpen, setIsExtensionModalOpen] = useState(false);
            const finalSortedProducts = useMemo(() => { return products.slice().sort((a, b) => { const nameComp = a.productName.localeCompare(b.productName); if (nameComp !== 0) return nameComp; const dateToCheckA = (a.category === 'Frozen' || a.category === 'Drinks') ? a.expireDate : a.albaikExpire; const dateToCheckB = (b.category === 'Frozen' || b.category === 'Drinks') ? b.expireDate : b.albaikExpire; const remainingA = calculateRemainingDays(dateToCheckA); const remainingB = calculateRemainingDays(dateToCheckB); if (remainingA === null) return 1; if (remainingB === null) return -1; return remainingA - remainingB; }); }, [products]);
            const expiredProducts = useMemo(() => { return products.filter(p => { const dateToCheck = p.category === 'Frozen' ? p.expireDate : p.albaikExpire; return calculateRemainingDays(dateToCheck) <= 0; }); }, [products]);
            const nextItemToUse = useMemo(() => { return [...products].filter(p => p.category !== 'Frozen' && p.category !== 'Drinks').sort((a, b) => new Date(a.albaikExpire).getTime() - new Date(b.albaikExpire).getTime())[0]; }, [products]);
            const usageOrderMap = useMemo(() => { const map = new Map(); const rankTracker = new Map(); finalSortedProducts.forEach(product => { const count = finalSortedProducts.filter(p => p.productName === product.productName).length; if (count > 1) { const rank = (rankTracker.get(product.productName) || 0) + 1; rankTracker.set(product.productName, rank); const suffix = n => { if (n > 3 && n < 21) return 'th'; switch (n % 10) { case 1: return 'st'; case 2: return 'nd'; case 3: return 'rd'; default: return 'th'; } }; map.set(product.id, `${rank}${suffix(rank)} Batch`); } }); return map; }, [finalSortedProducts]);
            const handleClearConfirm = () => { onClearAll(); setIsConfirmModalOpen(false); };
            if (products.length === 0) { return (<div className="text-center py-16 px-6 bg-white rounded-xl shadow-md border border-slate-200"><h3 className="text-xl font-semibold text-slate-700">No Products Yet</h3><p className="text-slate-500 mt-2">Add a product using the form above to get started.</p></div>); }
            return (<div className="bg-white rounded-xl shadow-md border border-slate-200 overflow-hidden relative"><ShareDialog isOpen={isShareDialogOpen} onClose={() => setIsShareDialogOpen(false)} products={products} /><ExtensionRequestModal isOpen={isExtensionModalOpen} onClose={() => setIsExtensionModalOpen(false)} expiredProducts={expiredProducts} /><ConfirmationModal isOpen={isConfirmModalOpen} onClose={() => setIsConfirmModalOpen(false)} onConfirm={handleClearConfirm} title="Clear All Products?"><p>Are you sure you want to delete all products? This action cannot be undone.</p></ConfirmationModal><div className="p-4 md:p-6 flex flex-wrap justify-between items-center gap-4 border-b border-slate-200"><h2 className="text-2xl font-bold text-slate-700">Inventory List</h2><div className="flex items-center gap-2 flex-wrap">{expiredProducts.length > 0 && (<button onClick={() => setIsExtensionModalOpen(true)} className="flex items-center gap-2 px-4 py-2 bg-yellow-100 text-yellow-800 font-semibold rounded-lg hover:bg-yellow-200 text-sm animate-pulse">ðŸš¨ Request Extension</button>)}<button onClick={() => setIsShareDialogOpen(true)} className="flex items-center gap-2 px-4 py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 text-sm"><ShareIcon className="w-4 h-4" /> Share / Export...</button><button onClick={() => setIsConfirmModalOpen(true)} disabled={isClearing} className="flex items-center gap-2 px-4 py-2 bg-red-50 text-red-600 font-semibold rounded-lg hover:bg-red-100 disabled:bg-red-50 disabled:text-red-300 text-sm"><TrashIcon className="w-4 h-4" /> {isClearing ? 'Clearing...' : 'Clear All'}</button></div></div><div className="overflow-x-auto"><table className="w-full text-sm text-left text-slate-600"><thead className="text-xs text-slate-700 uppercase bg-slate-100"><tr><th scope="col" className="px-6 py-3">Product Name</th><th scope="col" className="px-6 py-3">Batch No.</th><th scope="col" className="px-6 py-3">Prod. Date</th><th scope="col" className="px-6 py-3">Expire Date</th><th scope="col" className="px-6 py-3">Albaik Shelf Life</th><th scope="col" className="px-6 py-3 text-center">Quantity</th><th scope="col" className="px-6 py-3 text-center">Remain Days</th><th scope="col" className="px-6 py-3 text-right">Action</th></tr></thead><tbody>{finalSortedProducts.map((product) => { const remainingDays = calculateRemainingDays(product.category === 'Frozen' ? product.expireDate : product.albaikExpire); const usageLabel = usageOrderMap.get(product.id); const isNextToUse = nextItemToUse && product.id === nextItemToUse.id; return (<tr key={product.id} className={`border-b border-slate-200 hover:bg-slate-50 ${isNextToUse ? 'bg-red-50' : ''}`}><td className="px-6 py-4 font-medium text-slate-900"><div className="flex items-center gap-2">{product.productName}{usageLabel && <span className={`text-xs font-bold px-2 py-0.5 rounded-full ${usageLabel.startsWith('1st') ? 'text-red-600 bg-red-100' : 'text-slate-600 bg-slate-100'}`}>{usageLabel}</span>}</div></td><td className="px-6 py-4">{product.batchNumber || 'N/A'}</td><td className="px-6 py-4">{formatDate(product.productionDate)}</td><td className="px-6 py-4">{formatDate(product.expireDate)}</td><td className="px-6 py-4 font-semibold">{formatDate(product.albaikExpire)}</td><td className="px-6 py-4 text-center font-semibold text-slate-900">{`${product.quantityCarton || 0} Ctn, ${product.quantityPiece || 0} Pcs`}</td><td className="px-6 py-4 text-center"><RemainingDaysDisplay days={remainingDays} /></td><td className="px-6 py-4 text-right"><button onClick={() => onDeleteProduct(product.id)} className="text-slate-400 hover:text-red-600 p-1 rounded-full"><TrashIcon className="w-5 h-5" /></button></td></tr>); })}</tbody></table></div><div className="p-4 bg-slate-50 text-xs text-slate-500 flex items-center gap-2"><WarningIcon className="w-4 h-4 text-red-400" /><span>The <span className="font-bold text-red-600">highlighted row</span> indicates the next item to use overall (non-frozen/non-drink items only).</span></div></div>); };
        
        const App = () => {
            const [products, setProducts] = useState([]);
            const [isLoading, setIsLoading] = useState(true);
            const [isAdding, setIsAdding] = useState(false);
            const [isClearing, setIsClearing] = useState(false);
            const [error, setError] = useState(null);
            const loadProducts = useCallback(async () => { setIsLoading(true); try { await db.init(); const prods = await db.getAllProducts(); setProducts(prods); } catch (e) { setError("Could not load data from local database."); } finally { setIsLoading(false); } }, []);
            useEffect(() => { loadProducts(); }, [loadProducts]);
            const addProduct = useCallback(async (productData) => { setIsAdding(true); try { await db.init(); const allProducts = await db.getAllProducts(); const existingProduct = allProducts.find(p => p.productName === productData.productName && p.category === productData.category && p.productionDate === productData.productionDate && p.expireDate === productData.expireDate && p.albaikExpire === productData.albaikExpire); if (existingProduct) { existingProduct.quantityCarton = (existingProduct.quantityCarton || 0) + (productData.quantityCarton || 0); existingProduct.quantityPiece = (existingProduct.quantityPiece || 0) + (productData.quantityPiece || 0); await db.updateProduct(existingProduct); } else { await db.addProduct(productData); } await loadProducts(); } catch (e) { setError("Failed to save product."); } finally { setIsAdding(false); } }, [loadProducts]);
            const deleteProduct = useCallback(async (id) => { try { await db.deleteProduct(id); await loadProducts(); } catch (e) { setError("Failed to delete product."); } }, [loadProducts]);
            const clearAllProducts = useCallback(async () => { setIsClearing(true); try { await db.clearAllProducts(); await loadProducts(); } catch (e) { setError("Failed to clear all products."); } finally { setIsClearing(false); } }, [loadProducts]);
            return (
                <div className="min-h-screen font-sans">
                    <main className="container mx-auto px-4 py-8 md:py-12">
                        <header className="text-center mb-8 md:mb-12"><div className="inline-block bg-white p-4 rounded-full shadow-lg"><img src="https://cdn.brandfetch.io/idwmB-wz5R/w/800/h/899/theme/dark/symbol.png?c=1bxid64Mup7aczewSAYMX&t=1745978664233" alt="Albaik Logo" className="h-24 w-auto" /></div><h1 className="text-4xl md:text-5xl font-bold text-slate-800 tracking-tight mt-4">Inventory Management</h1><h2 className="text-2xl md:text-3xl font-semibold text-red-600 mt-2">KJ04 Hudaithi Mall</h2><p className="text-lg text-slate-500 max-w-2xl mx-auto mt-2">Developed By 'MD HAKIM MIA'</p></header>
                        {error && <div className="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-8 rounded-md"><p>{error}</p></div>}
                        <section className="mb-12 max-w-5xl mx-auto"><ProductForm onAddProduct={addProduct} isAdding={isAdding} /></section>
                        <section className="max-w-7xl mx-auto">{isLoading ? <div className="text-center py-12 text-slate-500">Loading Products...</div> : <ProductList products={products} onDeleteProduct={deleteProduct} onClearAll={clearAllProducts} isClearing={isClearing} />}</section>
                    </main>
                    <footer className="text-center py-6 text-sm text-slate-400"><p>Data is stored locally in your browser.</p><p className="mt-2">Built with React & Tailwind CSS</p></footer>
                </div>
            );
        };

        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        const { StrictMode } = React;
        root.render(
          <StrictMode>
            <App />
          </StrictMode>
        );

    </script>
    
    <script>
        if ('serviceWorker' in navigator) {
            const swCode = `
                const CACHE_NAME = 'albaik-inventory-cache-v1';
                self.addEventListener('install', event => { event.waitUntil(caches.open(CACHE_NAME).then(cache => { return cache.add(new Request('.')); })); });
                self.addEventListener('fetch', event => { if (event.request.mode === 'navigate') { event.respondWith(caches.match(event.request).then(response => { return response || fetch(event.request); })); } });
            `;
            const blob = new Blob([swCode], { type: 'application/javascript' });
            const swUrl = URL.createObjectURL(blob);
            window.addEventListener('load', () => { navigator.serviceWorker.register(swUrl).catch(error => console.log('SW Fail:', error)); });
        }
    </script>
</body>
</html>
