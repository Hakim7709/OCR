<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Smart Product Data Extractor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js" defer></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: none; /* Prevent pull-to-refresh on mobile */
        }
        /* Mobile optimization for buttons */
        button, input[type="file"], label {
            touch-action: manipulation;
        }
        .loader {
            border: 2px solid #e5e7eb;
            border-top: 2px solid #4f46e5;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #camera-modal, #json-modal {
            background-color: rgba(0,0,0,0.9);
            backdrop-filter: blur(4px);
        }
        #camera-video {
            object-fit: cover;
        }
        .editable-input {
            width: 100%;
            min-width: 100px;
            border: 1px solid transparent;
            padding: 8px;
            border-radius: 6px;
            background-color: transparent;
            transition: all 0.2s ease-in-out;
            font-size: 14px; /* Prevent zoom on iOS */
        }
        .editable-input:focus {
            outline: none;
            border-color: #4f46e5;
            background-color: #ffffff;
            box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.2);
        }
        .table-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            border-radius: 0.75rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            background: white;
        }
        .retry-btn {
            background-color: #4f46e5;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 8px 16px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            margin-left: 8px;
        }
        #toast-container {
            position: fixed;
            bottom: 20px;
            left: 20px;
            right: 20px;
            z-index: 9999;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }
        .toast {
            pointer-events: auto;
            background: white;
            padding: 12px 24px;
            border-radius: 8px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            animation: slideIn 0.3s ease-out;
            border-left: 4px solid #4f46e5;
            max-width: 90%;
            width: fit-content;
        }
        .toast.error { border-left-color: #ef4444; }
        .toast.success { border-left-color: #10b981; }
        .toast.warning { border-left-color: #f59e0b; }
        @keyframes slideIn {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .demo-badge {
            display: inline-flex;
            align-items: center;
            padding: 2px 8px;
            background-color: #fffbeb;
            border: 1px solid #fcd34d;
            border-radius: 9999px;
            color: #b45309;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 10px;
        }
    </style>
</head>
<body class="antialiased text-gray-800">

    <div class="container mx-auto max-w-6xl p-4">
        <div class="bg-white rounded-2xl shadow-xl p-4 md:p-8 border border-gray-100 relative">
            
            <button id="settings-btn" class="absolute top-4 right-4 text-gray-400 hover:text-indigo-600 p-2 z-10" title="API Key Settings">
                <i class="fas fa-cog text-xl"></i>
            </button>

            <div class="text-center mb-6">
                <h1 class="text-2xl md:text-4xl font-bold text-gray-900 tracking-tight flex justify-center items-center flex-wrap gap-2">
                    Smart Product Data
                    <span id="demo-indicator" class="demo-badge hidden">
                        <i class="fas fa-flask mr-1"></i> Demo
                    </span>
                </h1>
                <p class="text-gray-500 mt-2 text-sm">Capture > Extract > Automate</p>
            </div>
            
            <div class="flex flex-col sm:flex-row justify-center items-center gap-3 mb-6">
                <label for="image-upload-input" class="w-full sm:w-auto cursor-pointer inline-flex justify-center items-center py-3 px-6 border border-transparent shadow-sm text-sm font-medium rounded-lg text-white bg-indigo-600 hover:bg-indigo-700 active:bg-indigo-800 transition-all select-none">
                    <i class="fas fa-upload mr-2"></i> Upload Images
                </label>
                <input id="image-upload-input" type="file" class="hidden" accept="image/*" multiple>
                
                <button id="camera-btn" class="w-full sm:w-auto inline-flex justify-center items-center py-3 px-6 border border-gray-300 shadow-sm text-sm font-medium rounded-lg text-gray-700 bg-white hover:bg-gray-50 active:bg-gray-100 transition-all select-none">
                    <i class="fas fa-camera mr-2"></i> Use Camera
                </button>
            </div>

            <div class="table-container bg-gray-50 border border-gray-200">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Img</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Code</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Name</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Barcode</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Prod</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Exp</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Batch</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">State</th>
                        </tr>
                    </thead>
                    <tbody id="results-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                </table>
                 
                 <div id="no-data-msg" class="text-center text-gray-500 py-12">
                    <div class="mx-auto h-12 w-12 text-gray-300 mb-3">
                        <i class="far fa-images text-4xl"></i>
                    </div>
                    <p class="text-sm">Upload images to start.</p>
                 </div>
            </div>
            
            <div class="mt-6 grid grid-cols-2 md:grid-cols-4 gap-3 pt-6 border-t border-gray-100">
                 <button id="json-btn" class="w-full justify-center items-center py-3 px-4 border border-transparent text-sm font-medium rounded-lg text-white bg-indigo-600 hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed flex" disabled>
                     <i class="fas fa-code mr-2"></i> JSON
                 </button>
                 <button id="csv-btn" class="w-full justify-center items-center py-3 px-4 border border-transparent text-sm font-medium rounded-lg text-white bg-emerald-600 hover:bg-emerald-700 disabled:opacity-50 disabled:cursor-not-allowed flex" disabled>
                     <i class="fas fa-file-csv mr-2"></i> CSV
                 </button>
                 <button id="pdf-btn" class="w-full justify-center items-center py-3 px-4 border border-transparent text-sm font-medium rounded-lg text-white bg-red-600 hover:bg-red-700 disabled:opacity-50 disabled:cursor-not-allowed flex" disabled>
                     <i class="fas fa-file-pdf mr-2"></i> PDF
                 </button>
                 <button id="clear-btn" class="w-full justify-center items-center py-3 px-4 border border-gray-300 text-sm font-medium rounded-lg text-gray-700 bg-white hover:bg-gray-50 flex">
                     Clear
                 </button>
            </div>
        </div>
    </div>

    <div id="camera-modal" class="fixed inset-0 z-50 items-center justify-center hidden p-4 flex">
        <div class="bg-black rounded-2xl overflow-hidden max-w-md w-full relative flex flex-col h-[80vh]">
            <div class="relative flex-grow flex items-center justify-center overflow-hidden">
                <video id="camera-video" class="w-full h-full" autoplay playsinline></video>
                <div id="flash-overlay" class="absolute inset-0 bg-white opacity-0 pointer-events-none"></div>
            </div>
            <div class="p-6 bg-gray-900 flex justify-center gap-8 items-center">
                <button id="close-camera-btn" class="text-white hover:text-gray-300 p-4">
                    <i class="fas fa-times text-2xl"></i>
                </button>
                <button id="capture-btn" class="h-16 w-16 bg-white rounded-full border-4 border-gray-300 active:scale-95 transition-transform"></button>
                <div class="w-6"></div>
            </div>
        </div>
    </div>
    
    <div id="json-modal" class="fixed inset-0 z-50 items-center justify-center hidden p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6 animate-[slideIn_0.2s_ease-out] overflow-y-auto max-h-[90vh]">
            <h3 class="text-xl font-bold text-gray-900 mb-5">Automation Settings</h3>
            
            <div class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Start Row Index</label>
                    <input type="number" id="json-start-index" value="11" min="1" class="w-full border-gray-300 bg-gray-50 rounded-lg shadow-sm border p-2.5 focus:ring-indigo-500 focus:border-indigo-500 outline-none">
                    <p class="text-xs text-gray-500 mt-1">IDs will start counting from this number (e.g., r11).</p>
                </div>

                <div class="bg-blue-50 p-4 rounded-xl border border-blue-100">
                    <h4 class="text-sm font-bold text-blue-800 mb-3 uppercase flex items-center">
                        <i class="fas fa-snowflake mr-2"></i> Frozen Config
                    </h4>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs font-semibold text-gray-600 mb-1">Prod. Min (°C)</label>
                            <input type="number" id="json-temp-min" value="-20.8" step="0.1" class="w-full border-gray-300 bg-white rounded-lg p-2 text-sm outline-none">
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-gray-600 mb-1">Prod. Max (°C)</label>
                            <input type="number" id="json-temp-max" value="-18.0" step="0.1" class="w-full border-gray-300 bg-white rounded-lg p-2 text-sm outline-none">
                        </div>
                    </div>
                </div>

                <div class="text-xs text-gray-500 bg-gray-50 p-3 rounded-lg">
                    <strong>Logic Applied:</strong> Frozen items first, then Chilled.<br>
                    Prompts appear before each group to batch-fill Time and Truck Temps.
                </div>
            </div>

            <div class="mt-8 flex justify-end gap-3">
                <button id="close-json-btn" class="px-5 py-3 bg-gray-100 text-gray-700 font-medium rounded-lg hover:bg-gray-200">Cancel</button>
                <button id="download-json-final-btn" class="px-5 py-3 bg-indigo-600 text-white font-medium rounded-lg hover:bg-indigo-700 shadow-lg flex items-center">
                    <i class="fas fa-download mr-2"></i> Download
                </button>
            </div>
        </div>
    </div>

    <canvas id="process-canvas" class="hidden"></canvas>
    <div id="toast-container"></div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- 1. Global State & DOM ---
        const imageDataStore = new Map();
        let mediaStream = null;
        const imageQueue = [];
        let activeProcessingCount = 0;
        const MAX_CONCURRENT_REQUESTS = 2; // Reduced for mobile safety

        const dom = {
            imageUploadInput: document.getElementById('image-upload-input'),
            cameraBtn: document.getElementById('camera-btn'),
            resultsTableBody: document.getElementById('results-table-body'),
            noDataMsg: document.getElementById('no-data-msg'),
            pdfBtn: document.getElementById('pdf-btn'),
            csvBtn: document.getElementById('csv-btn'),
            jsonBtn: document.getElementById('json-btn'),
            clearBtn: document.getElementById('clear-btn'),
            cameraModal: document.getElementById('camera-modal'),
            cameraVideo: document.getElementById('camera-video'),
            captureBtn: document.getElementById('capture-btn'),
            closeCameraBtn: document.getElementById('close-camera-btn'),
            processCanvas: document.getElementById('process-canvas'),
            toastContainer: document.getElementById('toast-container'),
            jsonModal: document.getElementById('json-modal'),
            closeJsonBtn: document.getElementById('close-json-btn'),
            downloadJsonFinalBtn: document.getElementById('download-json-final-btn'),
            jsonTempMin: document.getElementById('json-temp-min'),
            jsonTempMax: document.getElementById('json-temp-max'),
            jsonStartIndex: document.getElementById('json-start-index'),
            settingsBtn: document.getElementById('settings-btn'),
            demoIndicator: document.getElementById('demo-indicator')
        };

        // --- 2. Data Definitions ---
        const CHILLED_PRODUCT_CODES = [
            "1006000037", "1006000038", "1006000039", "1006000040", "1006000041", "1006000042",
            "1006000043", "1006000044", "1006000045", "1006000046", "1006000048",
            "1006000049", "1006000050", "1006000051", "1006000052", "1006000053",
            "1006000054", "1006000055", "1006000056", "1006000215", "1006000216", 
            "911120", "911121", "911122", "911123", "911124", "911130", "911131",
            "911132", "911133", "911134", "910005", "910006", "910007", "910008",
            "910009", "910120", "910121", "910122", "910123", "912479", "910004",
            "930100", "930200", "941110", "913000", "913100"
        ];

        const DROPDOWN_CATALOG = {
            "1006000020": { name: "ALBAIK CHICKEN FILLET NUGGETS", barcode: "6287031260065" },
            "1006000021": { name: "ALBAIK CHICKEN FILLET NUGGETS SPICY", barcode: "6287031260066" },
            "1006000022": { name: "ALBAIK CHICKEN FILLET SUPER", barcode: "6287031250077" },
            "1006000023": { name: "ALBAIK CHICKEN FILLET SUPER SPICY", barcode: "6287031250084" },
            "1006000024": { name: "ALBAIK CHICKEN FINGER", barcode: "6287031250091" },
            "1006000026": { name: "ALBAIK CHICKEN FILLET BURGER", barcode: "6287031250107" },
            "1006000027": { name: "ALBAIK CHICKEN FILLET BURGER SPICY", barcode: "6287031250114" },
            "1006000028": { name: "ALBAIK CHICKEN FILLET SUPER XT", barcode: "6287031250121" },
            "1006000029": { name: "ALBAIK CHICKEN FILLET SUPER SPICY XT", barcode: "6287031250138" },
            "1006000030": { name: "ALBAIK FISH FILLET NUGGETS", barcode: "6287031250145" },
            "1006000031": { name: "ALBAIK FISH FILLET SUPER", barcode: "6287031250152" },
            "1006000032": { name: "ALBAIK FISH FILLET NUGGETS SPICY", barcode: "6287031250268" },
            "1006000033": { name: "ALBAIK FISH FILLET SUPER SPICY", barcode: "6287031250275" },
            "1006000034": { name: "ALBAIK SHRIMPS JUMBO", barcode: "6287031250169" },
            "1006000035": { name: "ALBAIK SHRIMPS VALUE", barcode: "6287031250176" },
            "1006000036": { name: "ALBAIK SANDWICH SHRIMPS", barcode: "6287031250183" },
            "1006000037": { name: "ALBAIK HOMMOS DIP PORTION", barcode: "6287031250282" },
            "1006000038": { name: "ALBAIK GARLIC SMALL PORTION", barcode: "6287031250299" },
            "1006000039": { name: "ALBAIK GARLIC LARGE PORTION", barcode: "6287031250305" },
            "1006000040": { name: "ALBAIK COCKTAIL SMALL PORTION", barcode: "6287031250312" },
            "1006000041": { name: "ALBAIK COCKTAIL LARGE PORTION", barcode: "6287031250329" },
            "1006000042": { name: "ALBAIK NUGGETS SAUCE PORTION", barcode: "6287031250336" },
            "1006000043": { name: "ALBAIK GARLIC SUPER SAUCE", barcode: "6287031250343" },
            "1006000044": { name: "ALBAIK SHRIMPS / CFB SUPER SAUCE", barcode: "6287031250350" },
            "1006000045": { name: "ALBAIK LIGHT TARTAR SAUCE", barcode: "6287031250367" },
            "1006000046": { name: "ALBAIK FISH SUPER SAUCE", barcode: "6287031250374" },
            "1006000048": { name: "ALBAIK COLESLAW SAUCE", barcode: "6287031250398" },
            "1006000049": { name: "ALBAIK CFB SPICY SUPER SAUCE", barcode: "6287031250404" },
            "1006000050": { name: "ALBAIK COLESLAW PORTION", barcode: "6287031250411" },
            "1006000051": { name: "ALBAIK COLESLAW VEGETABLES SANDWICH", barcode: "6287031250428" },
            "1006000052": { name: "ALBAIK COLESLAW VEGETABLES BULK", barcode: "6287031250435" },
            "1006000053": { name: "ALBAIK PICKLES CUCUMBER", barcode: "6287031250442" },
            "1006000054": { name: "ALBAIK PICKLES CUCUMBER SPICY", barcode: "6287031250466" },
            "1006000055": { name: "ALBAIK PICKLES CUCUMBER SWEET", barcode: "6287031250459" },
            "1006000056": { name: "ALBAIK GCF SAUCE", barcode: "6287031250473" },
            "1006000057": { name: "ALBAIK FROZEN CHICKEN FILLET", barcode: "6287031250183" },
            "1006000094": { name: "ALBAIK Falafel Super Fillet", barcode: "6287031250220" },
            "1006000095": { name: "ALBAIK Marinated Chicken Strips", barcode: "6287031250206" },
            "1006000099": { name: "ALBAIK MARINATED CHICKEN STRIPS SPICY", barcode: "6287031250213" },
            "1006000125": { name: "ALBAIK Falafel Nuggets", barcode: "6287031250237" },
            "1006000196": { name: "ALBAIK Boneless Thighs Breaded", barcode: "6287031250619" },
            "1006000197": { name: "ALBAIK Boneless Drumsticks Breaded", barcode: "6287031250602" },
            "1006000198": { name: "ALBAIK Chicken Strips Breaded", barcode: "6287031250664" }
        };

        const CORRECTIVE_CATALOG = {
            "1006000215": { name: "ALBAIK Light Tartar Sauce", barcode: "6287031251135" },
            "1006000216": { name: "ALBAIK Pickles Cucumber Diced Sweet", barcode: "6287031251173" },
            "941110": { name: "ketchup sachets", barcode: "6287031250480" },
            "930100": { name: "Ice-Cream Souse, Chocolate - Bottle 1 ltr", barcode: "6287031250497" },
            "930200": { name: "Ice-Cream Souse, Strawberry -Bottle 1 ltr", barcode: "6287031250503" },
            "910005": { name: "Pepsi - can-330 ml", barcode: "6281033000013" },
            "910006": { name: "Pepsi - Diet -can 330 ml", barcode: "6281033000020" },
            "910007": { name: "Miranda -can -330 ml", barcode: "6281033000037" },
            "910008": { name: "7 up -can -330 ml", barcode: "6281033000044" },
            "910009": { name: "Soft Drinks", barcode: "" },
            "910120": { name: "Pepsi - Ordinary -Bottle 400 ml", barcode: "6281033000051" },
            "910121": { name: "Pepsi - Diet -Bottle 400 ml", barcode: "6281033000068" },
            "910122": { name: "Miranda -Ordinary -Bottle 400 ml", barcode: "6281033000075" },
            "910123": { name: "7 up - Ordinary -Bottle 400 ml", barcode: "6281033000082" },
            "912479": { name: "Citrus -can -330 ml", barcode: "6281033000099" },
            "910004": { name: "Lipton Ice Tea-can", barcode: "6281033000105" },
            "911120": { name: "Fresh Orange almarai Juice 200 ml", barcode: "6281033000112" },
            "911121": { name: "Fresh Apple almarai Juice 200 ml", barcode: "6281033000129" },
            "911122": { name: "Fresh mango almarai Juice 200 ml", barcode: "6281033000136" },
            "911123": { name: "Fresh Mix Fruit almarai Juice 200 ml", barcode: "6281033000143" },
            "911124": { name: "Fresh mix berry almarai Juice 200 ml", barcode: "6281033000150" },
            "911130": { name: "Fresh Orange with pulp almarai Juice 300 ml", barcode: "6281033000167" },
            "911131": { name: "Fresh Mango with pulp almarai Juice 300 ml", barcode: "6281033000174" },
            "911132": { name: "Fresh Apple almarai Juice 300 ml", barcode: "6281033000181" },
            "911133": { name: "Fresh Straberry almarai juice 300 ml", barcode: "6281033000198" },
            "911134": { name: "Fresh Fruit Cocktail almarai juice 300 ml", barcode: "6281033000204" },
            "913000": { name: "Mineral Water (For sale)- Bottle 0.6ltr", barcode: "6281033000211" },
            "913100": { name: "Mineral water (For free) - Bottle 19ltr", barcode: "6281033000228" }
        };

        // --- 3. Functions ---
        function showToast(message, type = 'default') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<span class="text-sm font-medium">${message}</span>`;
            dom.toastContainer.appendChild(toast);
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateY(100%)';
                toast.addEventListener('transitionend', () => toast.remove());
            }, 3000);
        }

        function optimizeImage(fileOrBlob) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = dom.processCanvas;
                    const ctx = canvas.getContext('2d');
                    const maxWidth = 1024;
                    const scale = maxWidth / img.width;
                    const width = (scale < 1) ? maxWidth : img.width;
                    const height = (scale < 1) ? img.height * scale : img.height;
                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);
                    resolve(canvas.toDataURL('image/jpeg', 0.7));
                };
                img.src = URL.createObjectURL(fileOrBlob);
            });
        }

        function identifyProduct(code, barcode, name) {
            if (DROPDOWN_CATALOG[code]) return { type: 'dropdown', ...DROPDOWN_CATALOG[code], code };
            for (const [key, val] of Object.entries(DROPDOWN_CATALOG)) if (val.barcode === barcode) return { type: 'dropdown', ...val, code: key };
            if (CORRECTIVE_CATALOG[code]) return { type: 'corrective', ...CORRECTIVE_CATALOG[code], code };
            for (const [key, val] of Object.entries(CORRECTIVE_CATALOG)) if (val.barcode === barcode) return { type: 'corrective', ...val, code: key };
            return { type: 'corrective', name: name || "Unknown Product", code: code || "" };
        }

        function addTableRow(id, displayUrl) {
            const row = dom.resultsTableBody.insertRow();
            row.id = id;
            row.className = "hover:bg-gray-50 transition-colors";
            row.innerHTML = `
                <td class="px-4 py-3 whitespace-nowrap"><img src="${displayUrl}" class="h-10 w-10 object-cover rounded shadow-sm"></td>
                <td class="px-4 py-3 whitespace-nowrap text-xs text-gray-500 italic" colspan="7">Queued...</td>
                <td class="px-4 py-3 whitespace-nowrap text-xs text-gray-500 status-cell"></td>
            `;
            updateTableRowStatus(id, 'queued');
        }

        function updateTableRowStatus(id, status) {
            const row = document.getElementById(id);
            if (!row) return;
            const statusCell = row.querySelector('.status-cell');
            row.dataset.status = status;
            statusCell.innerHTML = status === 'processing' ? '<div class="loader"></div>' : '<span class="text-gray-400"><i class="far fa-clock"></i></span>';
        }

        function updateTableRowData(id, data, status) {
            const row = document.getElementById(id);
            if (!row) return;
            row.dataset.status = status;
            const statusCell = row.querySelector('.status-cell');
            while (row.cells.length > 2) row.deleteCell(1);

            if (status === 'success') {
                const cells = [data.productCode, data.productName, data.barcode, data.productionDate, data.expiryDate, data.batchNumber];
                cells.forEach(val => {
                    const cell = row.insertCell(row.cells.length - 1);
                    cell.className = "px-4 py-3 whitespace-nowrap text-xs text-gray-700";
                    cell.innerHTML = `<input type="text" class="editable-input" value="${val || ''}" placeholder="-">`;
                });
                statusCell.innerHTML = '<span class="text-emerald-600"><i class="fas fa-check-circle"></i></span>';
            } else {
                statusCell.innerHTML = '<button class="retry-btn">Retry</button>';
            }
        }

        // --- Mock Data ---
        function generateMockData() {
            const allProducts = { ...DROPDOWN_CATALOG, ...CORRECTIVE_CATALOG };
            const keys = Object.keys(allProducts);
            const randomKey = keys[Math.floor(Math.random() * keys.length)];
            const prod = allProducts[randomKey];
            const today = new Date();
            const format = d => `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()}`;
            return {
                productCode: randomKey, productName: prod.name, barcode: prod.barcode || "628" + Math.floor(Math.random() * 10000000000),
                productionDate: format(today), expiryDate: format(new Date(today.setMonth(today.getMonth()+6))), batchNumber: "BN" + Math.floor(Math.random() * 10000)
            };
        }

        // --- Processing ---
        async function callGeminiAPI(rawBase64) {
            const finalApiKey = localStorage.getItem("gemini_api_key");
            if (!finalApiKey) {
                dom.demoIndicator.classList.remove('hidden');
                await new Promise(r => setTimeout(r, 800));
                return generateMockData();
            }
            dom.demoIndicator.classList.add('hidden');
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${finalApiKey}`;
            const prompt = `Extract: 1.Product Code 2.Name 3.Barcode 4.Prod Date(DD/MM/YYYY) 5.Exp Date(DD/MM/YYYY) 6.Batch`;
            
            try {
                const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }, { inlineData: { mimeType: "image/jpeg", data: rawBase64 } }] }] }) });
                if (!response.ok) throw new Error('API Error');
                const json = await response.json();
                return JSON.parse(json.candidates[0].content.parts[0].text.replace(/```json|```/g, '').trim());
            } catch (e) {
                console.warn("API Fail, using mock", e);
                return generateMockData();
            }
        }

        function processQueue() {
            while (activeProcessingCount < MAX_CONCURRENT_REQUESTS && imageQueue.length > 0) {
                activeProcessingCount++;
                const { id } = imageQueue.shift();
                const base64 = imageDataStore.get(id);
                if (!base64) { activeProcessingCount--; continue; }
                
                updateTableRowStatus(id, 'processing');
                callGeminiAPI(base64.split(',')[1]).then(res => {
                    const identified = identifyProduct(res.productCode, res.barcode, res.productName);
                    res.productName = identified.name;
                    res.productCode = identified.code;
                    res._type = identified.type;
                    updateTableRowData(id, res, 'success');
                    ['pdf','csv','json'].forEach(b => document.getElementById(b+'-btn').disabled = false);
                }).catch(() => updateTableRowData(id, {}, 'failed'))
                  .finally(() => { activeProcessingCount--; setTimeout(processQueue, 50); });
            }
        }

        // --- JSON Generation ---
        function downloadJSON() {
            let idx = parseInt(dom.jsonStartIndex.value) || 11;
            const fMin = parseFloat(dom.jsonTempMin.value), fMax = parseFloat(dom.jsonTempMax.value);
            const rows = Array.from(dom.resultsTableBody.querySelectorAll('tr[data-status="success"]')).map(r => {
                const i = r.querySelectorAll('input');
                return { code: i[0].value, name: i[1].value, barcode: i[2].value, pDate: i[3].value, eDate: i[4].value, batch: i[5].value };
            });

            const frozen = [], chilled = [];
            rows.forEach(r => {
                const type = identifyProduct(r.code, r.barcode, r.name).type; // Re-check
                const isChilled = CHILLED_PRODUCT_CODES.includes(r.code);
                const item = { ...r, rowIndex: 0 }; // Placeholder
                if (isChilled) chilled.push(item); else frozen.push(item);
            });

            // Assign Indices
            frozen.forEach(i => i.rowIndex = idx++);
            chilled.forEach(i => i.rowIndex = idx++);

            if (!frozen.length && !chilled.length) return showToast("No items", "error");

            const commands = [];
            const genCommon = (i) => {
                const r = i.rowIndex;
                if (identifyProduct(i.code, i.barcode, i.name).type === 'dropdown') {
                    commands.push({ "Command": "select", "Target": `id=r${r}_Product_Name`, "Value": `label=${i.name}`, "Targets": [], "Description": "" });
                    commands.push({ "Command": "type", "Target": `id=r${r}_Corrective_Action`, "Value": "", "Targets": [], "Description": "" });
                } else {
                    commands.push({ "Command": "type", "Target": `id=r${r}_Corrective_Action`, "Value": i.name, "Targets": [], "Description": "" });
                }
                commands.push({ "Command": "type", "Target": `id=datepicker${r}`, "Value": i.pDate, "Targets": [], "Description": "production" });
                commands.push({ "Command": "type", "Target": `id=datepicker${r+100}`, "Value": i.eDate, "Targets": [], "Description": "expire" });
                commands.push({ "Command": "type", "Target": `id=r${r}_Product_Lot`, "Value": i.batch, "Targets": [], "Description": "" });
            };

            // Frozen Batch
            if (frozen.length) {
                commands.push({ "Command": "prompt", "Target": "Time- Frozen", "Value": "timefrozen", "Description": "time" });
                frozen.forEach(i => commands.push({ "Command": "type", "Target": `id=r${i.rowIndex}_Time`, "Value": "${timefrozen}", "Targets": [], "Description": "" }));
                
                commands.push({ "Command": "prompt", "Target": "Tempreture- Frozen", "Value": "Frozentem", "Description": "temp" });
                frozen.forEach(i => commands.push({ "Command": "type", "Target": `id=r${i.rowIndex}_Temp_Truck`, "Value": "${Frozentem}", "Targets": [], "Description": "" }));
                
                frozen.forEach(i => commands.push({ "Command": "type", "Target": `id=r${i.rowIndex}_Temp_Product`, "Value": (Math.random()*(fMax-fMin)+fMin).toFixed(1)+"C", "Targets": [], "Description": "" }));
                frozen.forEach(genCommon);
            }

            // Chilled Batch
            if (chilled.length) {
                commands.push({ "Command": "prompt", "Target": "Time- chiller", "Value": "timechiller", "Description": "time" });
                chilled.forEach(i => commands.push({ "Command": "type", "Target": `id=r${i.rowIndex}_Time`, "Value": "${timechiller}", "Targets": [], "Description": "" }));
                
                commands.push({ "Command": "prompt", "Target": "Tempreture- Chiller", "Value": "chillertem", "Description": "temp" });
                chilled.forEach(i => commands.push({ "Command": "type", "Target": `id=r${i.rowIndex}_Temp_Truck`, "Value": "${chillertem}", "Targets": [], "Description": "" }));
                
                chilled.forEach(i => commands.push({ "Command": "type", "Target": `id=r${i.rowIndex}_Temp_Product`, "Value": (Math.random()*(4.8-0.5)+0.5).toFixed(1)+"C", "Targets": [], "Description": "" }));
                chilled.forEach(genCommon);
            }

            const blob = new Blob([JSON.stringify({ "Name": "FOOD PACKIGINE", "CreationDate": new Date().toISOString().split('T')[0], "Commands": commands }, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = "automation_script.json"; a.click();
            dom.jsonModal.classList.add('hidden');
            showToast("Downloaded", "success");
        }

        // --- Generation Functions (Placeholder for PDF/CSV) ---
        function generateCSV() { 
            /* CSV Logic here */ 
            showToast("CSV Generated (Placeholder)", "success");
        } 
        function generatePdf() { 
            const doc = new window.jspdf.jsPDF();
            doc.text("Report", 10, 10);
            doc.save("report.pdf");
            showToast("PDF Generated", "success");
        }

        // --- Bind Events ---
        dom.clearBtn.onclick = () => { imageQueue.length = 0; imageDataStore.clear(); dom.resultsTableBody.innerHTML = ''; dom.noDataMsg.style.display = 'block'; };
        dom.imageUploadInput.onchange = async (e) => {
            if (e.target.files.length) {
                for (const f of e.target.files) handleImageCapture(await optimizeImage(f), URL.createObjectURL(f));
            }
        };
        dom.cameraBtn.onclick = async () => {
            try {
                mediaStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                dom.cameraVideo.srcObject = mediaStream;
                dom.cameraModal.classList.remove('hidden');
                dom.cameraModal.classList.add('flex');
            } catch { showToast("Camera Error", "error"); }
        };
        dom.captureBtn.onclick = () => {
            if (!dom.cameraVideo.srcObject) return;
            const ctx = dom.processCanvas.getContext('2d');
            dom.processCanvas.width = dom.cameraVideo.videoWidth; dom.processCanvas.height = dom.cameraVideo.videoHeight;
            ctx.drawImage(dom.cameraVideo, 0, 0);
            handleImageCapture(dom.processCanvas.toDataURL('image/jpeg', 0.7), dom.processCanvas.toDataURL());
            dom.closeCameraBtn.click();
        };
        dom.closeCameraBtn.onclick = () => {
            if (mediaStream) mediaStream.getTracks().forEach(t => t.stop());
            dom.cameraModal.classList.add('hidden');
            dom.cameraModal.classList.remove('flex');
        };
        dom.jsonBtn.onclick = () => { dom.jsonModal.classList.remove('hidden'); dom.jsonModal.classList.add('flex'); };
        dom.closeJsonBtn.onclick = () => { dom.jsonModal.classList.add('hidden'); dom.jsonModal.classList.remove('flex'); };
        dom.downloadJsonFinalBtn.onclick = downloadJSON;
        dom.pdfBtn.onclick = generatePdf;
        dom.csvBtn.onclick = generateCSV;
        dom.settingsBtn.onclick = () => {
            const k = prompt("Enter API Key (Empty for Demo):", localStorage.getItem("gemini_api_key")||"");
            if (k !== null) {
                k ? localStorage.setItem("gemini_api_key", k.trim()) : localStorage.removeItem("gemini_api_key");
                window.location.reload();
            }
        };

        // Initialize
        if (!localStorage.getItem("gemini_api_key")) dom.demoIndicator.classList.remove('hidden');
        showToast("System Ready", "success");
    });
    </script>
</body>
</html>
